(()=>{frappe.provide("erpnext");$.extend(frappe.breadcrumbs.preferred,{"Item Group":"Stock","Customer Group":"Selling","Supplier Group":"Buying",Territory:"Selling","Sales Person":"Selling","Sales Partner":"Selling",Brand:"Stock","Maintenance Schedule":"Support","Maintenance Visit":"Support"});$.extend(frappe.breadcrumbs.module_map,{"ERPNext Integrations":"Integrations",Geo:"Settings",Portal:"Website",Utilities:"Settings","E-commerce":"Website",Contacts:"CRM"});frappe.provide("erpnext");frappe.provide("erpnext.utils");$.extend(erpnext,{get_currency:function(i){return!i&&cur_frm&&(i=cur_frm.doc.company),i&&frappe.get_doc(":Company",i).default_currency||frappe.boot.sysdefaults.currency},get_presentation_currency_list:()=>{let e=frappe.boot.docs.filter(t=>t.doctype===":Currency").map(t=>t.name);return e.unshift(""),e},toggle_naming_series:function(){cur_frm.fields_dict.naming_series&&cur_frm.toggle_display("naming_series",!!cur_frm.doc.__islocal)},hide_company:function(){if(cur_frm.fields_dict.company){var i=Object.keys(locals[":Company"]||{});i.length===1?(cur_frm.doc.company||cur_frm.set_value("company",i[0]),cur_frm.toggle_display("company",!1)):erpnext.last_selected_company&&(cur_frm.doc.company||cur_frm.set_value("company",erpnext.last_selected_company))}},is_perpetual_inventory_enabled:function(i){if(i)return frappe.get_doc(":Company",i).enable_perpetual_inventory},stale_rate_allowed:()=>cint(frappe.boot.sysdefaults.allow_stale),setup_serial_or_batch_no:function(){let i=cur_frm.open_grid_row();!i||!i.grid_form.fields_dict.serial_no||i.grid_form.fields_dict.serial_no.get_status()!=="Write"||frappe.model.get_value("Item",{name:i.doc.item_code},["has_serial_no","has_batch_no"],({has_serial_no:e,has_batch_no:t})=>{Object.assign(i.doc,{has_serial_no:e,has_batch_no:t}),e?h(__("Add Serial No"),i.grid_form.fields_dict.serial_no.$wrapper,this,i):t&&h(__("Pick Batch No"),i.grid_form.fields_dict.batch_no.$wrapper,this,i)})},route_to_adjustment_jv:i=>{frappe.model.with_doctype("Journal Entry",()=>{let e=frappe.model.get_new_doc("Journal Entry");i.accounts.forEach(t=>{let a=frappe.model.add_child(e,"accounts");a.account=t.account,a.debit_in_account_currency=t.debit_in_account_currency,a.credit_in_account_currency=t.credit_in_account_currency,a.party_type=""}),frappe.set_route("Form","Journal Entry",e.name)})},route_to_pending_reposts:i=>{frappe.set_route("List","Repost Item Valuation",i)},proceed_save_with_reminders_frequency_change:()=>{frappe.ui.hide_open_dialog(),frappe.call({method:"erpnext.hr.doctype.hr_settings.hr_settings.set_proceed_with_frequency_change",callback:()=>{cur_frm.save()}})}});$.extend(erpnext.utils,{set_party_dashboard_indicators:function(i){if(i.doc.__onload&&i.doc.__onload.dashboard_info){var e=i.doc.__onload.dashboard_info;e.length>1?e.forEach(function(t){erpnext.utils.add_indicator_for_multicompany(i,t)}):e.length===1&&(i.dashboard.add_indicator(__("Annual Billing: {0}",[format_currency(e[0].billing_this_year,e[0].currency)]),"blue"),i.dashboard.add_indicator(__("Total Unpaid: {0}",[format_currency(e[0].total_unpaid,e[0].currency)]),e[0].total_unpaid?"orange":"green"),e[0].loyalty_points&&i.dashboard.add_indicator(__("Loyalty Points: {0}",[e[0].loyalty_points]),"blue"))}},add_indicator_for_multicompany:function(i,e){i.dashboard.stats_area.removeClass("hidden"),i.dashboard.stats_area_row.addClass("flex"),i.dashboard.stats_area_row.css("flex-wrap","wrap");var t=e.total_unpaid?"orange":"green",a=$('<div class="flex-column col-xs-6"><div style="margin-top:10px"><h6>'+e.company+'</h6></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Annual Billing: '+format_currency(e.billing_this_year,e.currency)+'</span></div><div class="badge-link small" style="margin-bottom:10px"><span class="indicator '+t+'">Total Unpaid: '+format_currency(e.total_unpaid,e.currency)+"</span></div></div>").appendTo(i.dashboard.stats_area_row);return e.loyalty_points&&$('<div class="badge-link small" style="margin-bottom:10px"><span class="indicator blue">Loyalty Points: '+e.loyalty_points+"</span></div>").appendTo(a),a},get_party_name:function(i){var e={Customer:"customer_name",Supplier:"supplier_name",Employee:"employee_name",Member:"member_name"};return e[i]},copy_value_in_all_rows:function(i,e,t,a,r){var s=locals[e][t];if(s[r])for(var n=i[a]||[],l=0;l<n.length;l++)n[l][r]||(n[l][r]=s[r]);refresh_field(a)},get_terms:function(i,e,t){if(i)return frappe.call({method:"erpnext.setup.doctype.terms_and_conditions.terms_and_conditions.get_terms_and_conditions",args:{template_name:i,doc:e},callback:function(a){t(a)}})},make_bank_account:function(i,e){frappe.call({method:"erpnext.accounts.doctype.bank_account.bank_account.make_bank_account",args:{doctype:i,docname:e},freeze:!0,callback:function(t){var a=frappe.model.sync(t.message);frappe.set_route("Form",a[0].doctype,a[0].name)}})},add_dimensions:function(i,e){let t=frappe.query_reports[i].filters;frappe.call({method:"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions",callback:function(a){a.message[0].forEach(s=>{t.some(l=>l.fieldname===s.fieldname)||t.splice(e,0,{fieldname:s.fieldname,label:__(s.label),fieldtype:"Link",options:s.document_type})})}})},make_subscription:function(i,e){frappe.call({method:"frappe.automation.doctype.auto_repeat.auto_repeat.make_auto_repeat",args:{doctype:i,docname:e},callback:function(t){var a=frappe.model.sync(t.message);frappe.set_route("Form",a[0].doctype,a[0].name)}})},make_pricing_rule:function(i,e){frappe.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.make_pricing_rule",args:{doctype:i,docname:e},callback:function(t){var a=frappe.model.sync(t.message);frappe.set_route("Form",a[0].doctype,a[0].name)}})},first_row_is_empty:function(i){return $.isArray(i)&&i.length>0?!i[0].item_code:!1},remove_empty_first_row:function(i,e){let t=i.doc[e];return this.first_row_is_empty(t)&&(i.doc[e]=t.splice(1)),t},get_tree_options:function(i){let e=frappe.model.unscrub(i),t=frappe.defaults.get_user_permissions(),a;return t&&t[e]?a=t[e].map(r=>r.doc):a=$.map(locals[`:${e}`],function(r){return r.name}).sort(),a.filter((r,s,n)=>n.indexOf(r)===s)},get_tree_default:function(i){let e=this.get_tree_options(i);return e.includes(frappe.defaults.get_default(i))?frappe.defaults.get_default(i):e[0]},overrides_parent_value_in_all_rows:function(i,e,t,a,r,s){if(i[s]){let n=i[a]||[];for(let l=0;l<n.length;l++)n[l][r]=i[s];frappe.refresh_field(a)}},create_new_doc:function(i,e){frappe.model.with_doctype(i,function(){var t=frappe.model.get_new_doc(i);for(let[a,r]of Object.entries(e))t[a]=r;frappe.ui.form.make_quick_entry(i,null,null,t)})}});erpnext.utils.select_alternate_items=function(i){let e=i.frm,t=i.warehouse_field||"warehouse",a=i.item_field||"item_code";this.data=[];let r=new frappe.ui.Dialog({title:__("Select Alternate Item"),fields:[{fieldtype:"Section Break",label:__("Items")},{fieldname:"alternative_items",fieldtype:"Table",cannot_add_rows:!0,in_place_edit:!0,data:this.data,get_data:()=>this.data,fields:[{fieldtype:"Data",fieldname:"docname",hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:1,label:__("Item Code")},{fieldtype:"Link",fieldname:"alternate_item",options:"Item",default:"",in_list_view:1,label:__("Alternate Item"),onchange:function(){let s=this.get_value(),n=this.grid_row.on_grid_fields_dict.warehouse.get_value();s&&n&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:s,warehouse:n},callback:l=>{this.grid_row.on_grid_fields_dict.actual_qty.set_value(l.message||0)}})},get_query:s=>({query:"erpnext.stock.doctype.item_alternative.item_alternative.get_alternative_items",filters:{item_code:s.item_code}})},{fieldtype:"Link",fieldname:"warehouse",options:"Warehouse",default:"",in_list_view:1,label:__("Warehouse"),onchange:function(){let s=this.get_value(),n=this.grid_row.on_grid_fields_dict.item_code.get_value();n&&s&&frappe.call({method:"erpnext.stock.utils.get_latest_stock_qty",args:{item_code:n,warehouse:s},callback:l=>{this.grid_row.on_grid_fields_dict.actual_qty.set_value(l.message||0)}})}},{fieldtype:"Float",fieldname:"actual_qty",default:0,read_only:1,in_list_view:1,label:__("Available Qty")}]}],primary_action:function(){this.get_values().alternative_items.filter(l=>{if(l.alternate_item&&l.item_code!=l.alternate_item)return!0}).forEach(l=>{let c=frappe.get_doc(i.child_doctype,l.docname),_=null;c.doctype==="Work Order Item"?_=c.required_qty:_=c.qty,c[a]=l.alternate_item,frappe.model.set_value(c.doctype,c.name,"qty",_),frappe.model.set_value(c.doctype,c.name,i.original_item_field,l.item_code),e.trigger(a,c.doctype,c.name)}),refresh_field(i.child_docname),this.hide()},primary_action_label:__("Update")});e.doc[i.child_docname].forEach(s=>{(!i.condition||i.condition(s))&&r.fields_dict.alternative_items.df.data.push({docname:s.name,item_code:s[a],warehouse:s[t],actual_qty:s.actual_qty})}),this.data=r.fields_dict.alternative_items.df.data,r.fields_dict.alternative_items.grid.refresh(),r.show()};erpnext.utils.update_child_items=function(i){let e=i.frm,t=typeof i.cannot_add_row=="undefined"?!0:i.cannot_add_row,a=typeof i.cannot_add_row=="undefined"?"items":i.child_docname,r=frappe.get_meta(`${e.doc.doctype} Item`),s=c=>r.fields.find(_=>_.fieldname==c).precision;this.data=[];let n=[{fieldtype:"Data",fieldname:"docname",read_only:1,hidden:1},{fieldtype:"Link",fieldname:"item_code",options:"Item",in_list_view:1,read_only:0,disabled:0,label:__("Item Code"),get_query:function(){let c;return e.doc.doctype=="Sales Order"?c={is_sales_item:1}:e.doc.doctype=="Purchase Order"&&(e.doc.is_subcontracted=="Yes"?c={is_sub_contracted_item:1}:c={is_purchase_item:1}),{query:"erpnext.controllers.queries.item_query",filters:c}}},{fieldtype:"Link",fieldname:"uom",options:"UOM",read_only:0,label:__("UOM"),reqd:1,onchange:function(){frappe.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:this.doc.item_code,uom:this.value},callback:c=>{if(!c.exc){if(this.doc.conversion_factor==c.message.conversion_factor)return;let _=this.doc.docname;l.fields_dict.trans_items.df.data.some(d=>{if(d.docname==_)return d.conversion_factor=c.message.conversion_factor,l.fields_dict.trans_items.grid.refresh(),!0})}}})}},{fieldtype:"Float",fieldname:"qty",default:0,read_only:0,in_list_view:1,label:__("Qty"),precision:s("qty")},{fieldtype:"Currency",fieldname:"rate",options:"currency",default:0,read_only:0,in_list_view:1,label:__("Rate"),precision:s("rate")}];(e.doc.doctype=="Sales Order"||e.doc.doctype=="Purchase Order")&&(n.splice(2,0,{fieldtype:"Date",fieldname:e.doc.doctype=="Sales Order"?"delivery_date":"schedule_date",in_list_view:1,label:e.doc.doctype=="Sales Order"?__("Delivery Date"):__("Reqd by date"),reqd:1}),n.splice(3,0,{fieldtype:"Float",fieldname:"conversion_factor",in_list_view:1,label:__("Conversion Factor"),precision:s("conversion_factor")}));let l=new frappe.ui.Dialog({title:__("Update Items"),fields:[{fieldname:"trans_items",fieldtype:"Table",label:"Items",cannot_add_rows:t,in_place_edit:!1,reqd:1,data:this.data,get_data:()=>this.data,fields:n}],primary_action:function(){let c=this.get_values().trans_items.filter(_=>!!_.item_code);frappe.call({method:"erpnext.controllers.accounts_controller.update_child_qty_rate",freeze:!0,args:{parent_doctype:e.doc.doctype,trans_items:c,parent_doctype_name:e.doc.name,child_docname:a},callback:function(){e.reload_doc()}}),this.hide(),refresh_field("items")},primary_action_label:__("Update")});e.doc[i.child_docname].forEach(c=>{l.fields_dict.trans_items.df.data.push({docname:c.name,name:c.name,item_code:c.item_code,delivery_date:c.delivery_date,schedule_date:c.schedule_date,conversion_factor:c.conversion_factor,qty:c.qty,rate:c.rate,uom:c.uom}),this.data=l.fields_dict.trans_items.df.data,l.fields_dict.trans_items.grid.refresh()}),l.show()};erpnext.utils.map_current_doc=function(i){function e(){if($.isArray(cur_frm.doc.items)&&cur_frm.doc.items.length>0){cur_frm.doc.items[0].item_code||(cur_frm.doc.items=cur_frm.doc.items.splice(1));var a=frappe.meta.get_docfield(cur_frm.doctype,"items").options,r=null;frappe.get_meta(a).fields.forEach(function(l){l.options===i.source_doctype&&(r=l.fieldname)});var s=!1,n={};$.each(cur_frm.doc.items,function(l,c){i.source_name.forEach(function(_){c[r]==_&&(s=!0,n[c.item_code]?n[c.item_code]+=flt(c.qty):n[c.item_code]=flt(c.qty))})}),s&&i.source_name.forEach(function(l){if(frappe.model.with_doc(i.source_doctype,l,function(c){var _=frappe.model.get_doc(i.source_doctype,l);$.each(_.items||[],function(d,p){if(p.qty>flt(n[p.item_code]))return s=!1,!1})}),s){frappe.msgprint(__("You have already selected items from {0} {1}",[i.source_doctype,l]));return}})}return frappe.call({type:"POST",method:"frappe.model.mapper.map_docs",args:{method:i.method,source_names:i.source_name,target_doc:cur_frm.doc,args:i.args},callback:function(l){if(!l.exc){var c=frappe.model.sync(l.message);cur_frm.dirty(),cur_frm.refresh()}}})}let t={};if(i.get_query_filters&&(t.filters=i.get_query_filters),i.get_query_method&&(t.query=i.get_query_method),(t.filters||t.query)&&(i.get_query=()=>t),i.source_doctype){let a=new frappe.ui.form.MultiSelectDialog({doctype:i.source_doctype,target:i.target,date_field:i.date_field||void 0,setters:i.setters,get_query:i.get_query,add_filters_group:1,allow_child_item_selection:i.allow_child_item_selection,child_fieldname:i.child_fielname,child_columns:i.child_columns,size:i.size,action:function(r,s){let n=r;if(n.length===0){frappe.msgprint(__("Please select {0}",[i.source_doctype]));return}i.source_name=n,i.allow_child_item_selection&&(i.args=s),a.dialog.hide(),e()}});return a}i.source_name&&(i.source_name=[i.source_name],e())};frappe.form.link_formatters.Item=function(i,e){return e&&i&&e.item_name&&e.item_name!==i&&e.item_code===i?i+": "+e.item_name:!i&&e.doctype&&e.item_name?e.item_name:i};frappe.form.link_formatters.Employee=function(i,e){return e&&i&&e.employee_name&&e.employee_name!==i&&e.employee===i?i+": "+e.employee_name:!i&&e.doctype&&e.employee_name?e.employee:i};frappe.form.link_formatters.Project=function(i,e){return e&&i&&e.project_name&&e.project_name!==i&&e.project===i?i+": "+e.project_name:!i&&e.doctype&&e.project_name?e.project:i};$(document).on("app_ready",function(){frappe.datetime.is_timezone_same()||$.each(["Stock Reconciliation","Stock Entry","Stock Ledger Entry","Delivery Note","Purchase Receipt","Sales Invoice"],function(i,e){frappe.ui.form.on(e,"onload",function(t){cur_frm.set_df_property("posting_time","description",frappe.sys_defaults.time_zone)})})});$(document).on("app_ready",function(){frappe.call({method:"erpnext.support.doctype.service_level_agreement.service_level_agreement.get_sla_doctypes",callback:function(i){!i.message||$.each(i.message,function(e,t){frappe.ui.form.on(t,{onload:function(a){!a.doc.service_level_agreement||frappe.call({method:"erpnext.support.doctype.service_level_agreement.service_level_agreement.get_service_level_agreement_filters",args:{doctype:a.doc.doctype,name:a.doc.service_level_agreement,customer:a.doc.customer},callback:function(r){r&&r.message&&(a.set_query("priority",function(){return{filters:{name:["in",r.message.priority]}}}),a.set_query("service_level_agreement",function(){return{filters:{name:["in",r.message.service_level_agreements]}}}))}})},refresh:function(a){if(a.doc.status!=="Closed"&&a.doc.service_level_agreement&&["First Response Due","Resolution Due"].includes(a.doc.agreement_status))frappe.call({method:"frappe.client.get",args:{doctype:"Service Level Agreement",name:a.doc.service_level_agreement},callback:function(r){let s=r.message.pause_sla_on,n=[];if($.each(s,(l,c)=>{n.push(c.status)}),n.includes(a.doc.status)){a.dashboard.clear_headline();let l={indicator:"orange",msg:__("SLA is on hold since {0}",[moment(a.doc.on_hold_since).fromNow(!0)])};a.dashboard.set_headline_alert('<div class="row"><div class="col-xs-12"><span class="indicator whitespace-nowrap '+l.indicator+'"><span>'+l.msg+"</span></span> </div></div>")}else y(a,r.message.apply_sla_for_resolution)}});else if(a.doc.service_level_agreement){a.dashboard.clear_headline();let r=a.doc.agreement_status=="Fulfilled"?{indicator:"green",msg:"Service Level Agreement has been fulfilled"}:{indicator:"red",msg:"Service Level Agreement Failed"};a.dashboard.set_headline_alert('<div class="row"><div class="col-xs-12"><span class="indicator whitespace-nowrap '+r.indicator+'"><span class="hidden-xs">'+r.msg+"</span></span> </div></div>")}}})})}})});function y(i,e){i.dashboard.clear_headline();let t;i.doc.first_responded_on?t=f(i.doc.response_by,i.doc.first_responded_on):t=m(i.doc.response_by,i.doc.agreement_status);let a=`
		<div class="row">
			<div class="col-xs-12 col-sm-6">
				<span class="indicator whitespace-nowrap ${t.indicator}">
					<span>Time to Respond: ${t.diff_display}</span>
				</span>
			</div>`;if(e){let r;i.doc.resolution_date?r=f(i.doc.resolution_by,i.doc.resolution_date):r=m(i.doc.resolution_by,i.doc.agreement_status),a+=`
			<div class="col-xs-12 col-sm-6">
				<span class="indicator whitespace-nowrap ${r.indicator}">
					<span>Time to Resolve: ${r.diff_display}</span>
				</span>
			</div>`}a+="</div>",i.dashboard.set_headline_alert(a)}function m(i,e){let t=moment(i).diff(moment()),a=t>=44500?moment.duration(t).humanize():"Failed",r=a=="Failed"&&e!="Fulfilled"?"red":"green";return{diff_display:a,indicator:r}}function f(i,e){return moment(i).diff(moment(e))>=0?{diff_display:"Fulfilled",indicator:"green"}:{diff_display:"Failed",indicator:"red"}}function h(i,e,t,a){let r=$("<div>").css({"margin-bottom":"10px","margin-top":"10px"}).appendTo(e);$(`<button class="btn btn-sm btn-default">${i}</button>`).appendTo(r).on("click",function(){t.show_serial_batch_selector(a.frm,a.doc,"","",!0)})}frappe.provide("erpnext.queries");$.extend(erpnext.queries,{user:function(){return{query:"frappe.core.doctype.user.user.user_query"}},lead:function(){return{query:"erpnext.controllers.queries.lead_query"}},customer:function(){return{query:"erpnext.controllers.queries.customer_query"}},supplier:function(){return{query:"erpnext.controllers.queries.supplier_query"}},item:function(i){var e={query:"erpnext.controllers.queries.item_query"};return i&&(e.filters=i),e},bom:function(){return{query:"erpnext.controllers.queries.bom"}},task:function(){return{query:"erpnext.projects.utils.query_task"}},customer_filter:function(i){return i.customer||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(i.doctype,"customer",i.name))])),{filters:{customer:i.customer}}},contact_query:function(i){if(frappe.dynamic_link)return i[frappe.dynamic_link.fieldname]||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(i.doctype,frappe.dynamic_link.fieldname,i.name))])),{query:"frappe.contacts.doctype.contact.contact.contact_query",filters:{link_doctype:frappe.dynamic_link.doctype,link_name:i[frappe.dynamic_link.fieldname]}}},address_query:function(i){if(frappe.dynamic_link)return i[frappe.dynamic_link.fieldname]||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(i.doctype,frappe.dynamic_link.fieldname,i.name))])),{query:"frappe.contacts.doctype.address.address.address_query",filters:{link_doctype:frappe.dynamic_link.doctype,link_name:i[frappe.dynamic_link.fieldname]}}},company_address_query:function(i){return{query:"frappe.contacts.doctype.address.address.address_query",filters:{is_your_company_address:1,link_doctype:"Company",link_name:i.company||""}}},dispatch_address_query:function(i){return{query:"frappe.contacts.doctype.address.address.address_query",filters:{link_doctype:"Company",link_name:i.company||""}}},supplier_filter:function(i){return i.supplier||frappe.throw(__("Please set {0}",[__(frappe.meta.get_label(i.doctype,"supplier",i.name))])),{filters:{supplier:i.supplier}}},lead_filter:function(i){return i.lead||frappe.throw(__("Please specify a {0}",[__(frappe.meta.get_label(i.doctype,"lead",i.name))])),{filters:{lead:i.lead}}},not_a_group_filter:function(){return{filters:{is_group:0}}},employee:function(){return{query:"erpnext.controllers.queries.employee_query"}},warehouse:function(i){return{filters:[["Warehouse","company","in",["",cstr(i.company)]],["Warehouse","is_group","=",0]]}},get_filtered_dimensions:function(i,e,t,a){let r="";return e.forEach(s=>{r||(r=i[s])}),{query:"erpnext.controllers.queries.get_filtered_dimensions",filters:{dimension:t,account:r,company:a}}}});erpnext.queries.setup_queries=function(i,e,t){var a=this,r=function(s,n){var l=frappe.meta.get_docfields(s,i.doc.name,{fieldtype:"Link",options:e});$.each(l,function(c,_){n?i.set_query(_.fieldname,n,t):i.set_query(_.fieldname,t)})};r(i.doc.doctype),$.each(frappe.meta.get_docfields(i.doc.doctype,i.doc.name,{fieldtype:"Table"}),function(s,n){r(n.options,n.fieldname)})};erpnext.queries.setup_warehouse_query=function(i){i.set_query("warehouse","items",function(e,t,a){var r=locals[t][a],s=erpnext.queries.warehouse(i.doc);return r.item_code&&($.extend(s,{query:"erpnext.controllers.queries.warehouse_query"}),s.filters.push(["Bin","item_code","=",r.item_code])),s})};erpnext.SMSManager=function(e){var t=this;this.setup=function(){var a={Lead:"",Opportunity:"Your enquiry has been logged into the system. Ref No: "+e.name,Quotation:"Quotation "+e.name+" has been sent via email. Thanks!","Sales Order":"Sales Order "+e.name+" has been created against "+(e.quotation_no?"Quote No:"+e.quotation_no:"")+(e.po_no?" for your PO: "+e.po_no:""),"Delivery Note":"Items has been delivered against delivery note: "+e.name+(e.po_no?" for your PO: "+e.po_no:""),"Sales Invoice":"Invoice "+e.name+" has been sent via email "+(e.po_no?" for your PO: "+e.po_no:""),"Material Request":"Material Request "+e.name+" has been raised in the system","Purchase Order":"Purchase Order "+e.name+" has been sent via email","Purchase Receipt":"Items has been received against purchase receipt: "+e.name};in_list(["Sales Order","Delivery Note","Sales Invoice"],e.doctype)?this.show(e.contact_person,"Customer",e.customer,"",a[e.doctype]):e.doctype==="Quotation"?this.show(e.contact_person,"Customer",e.party_name,"",a[e.doctype]):in_list(["Purchase Order","Purchase Receipt"],e.doctype)?this.show(e.contact_person,"Supplier",e.supplier,"",a[e.doctype]):e.doctype=="Lead"?this.show("","","",e.mobile_no,a[e.doctype]):e.doctype=="Opportunity"?this.show("","","",e.contact_no,a[e.doctype]):e.doctype=="Material Request"&&this.show("","","","",a[e.doctype])},this.get_contact_number=function(a,r,s){frappe.call({method:"frappe.core.doctype.sms_settings.sms_settings.get_contact_number",args:{contact_name:a,ref_doctype:r,ref_name:s},callback:function(n){if(n.exc){frappe.msgprint(n.exc);return}t.number=n.message,t.show_dialog()}})},this.show=function(a,r,s,n,l){this.message=l,n?(t.number=n,t.show_dialog()):a?this.get_contact_number(a,r,s):t.show_dialog()},this.show_dialog=function(){t.dialog||t.make_dialog(),t.dialog.set_values({message:t.message,number:t.number}),t.dialog.show()},this.make_dialog=function(){var a=new frappe.ui.Dialog({title:"Send SMS",width:400,fields:[{fieldname:"number",fieldtype:"Data",label:"Mobile Number",reqd:1},{fieldname:"message",fieldtype:"Text",label:"Message",reqd:1},{fieldname:"send",fieldtype:"Button",label:"Send"}]});a.fields_dict.send.input.onclick=function(){var r=a.fields_dict.send.input,s=t.dialog.get_values();s&&($(r).set_working(),frappe.call({method:"frappe.core.doctype.sms_settings.sms_settings.send_sms",args:{receiver_list:[s.number],msg:s.message},callback:function(n){if($(r).done_working(),n.exc){frappe.msgprint(n.exc);return}t.dialog.hide()}}))},this.dialog=a},this.setup()};frappe.provide("erpnext.utils");erpnext.utils.get_party_details=function(i,e,t,a){if(e||(e="erpnext.accounts.party.get_party_details"),t&&(in_list(["Sales Invoice","Sales Order","Delivery Note"],i.doc.doctype)&&i.doc.company_address&&!t.company_address&&(t.company_address=i.doc.company_address),in_list(["Purchase Invoice","Purchase Order","Purchase Receipt"],i.doc.doctype)&&i.doc.shipping_address&&!t.shipping_address&&(t.shipping_address=i.doc.shipping_address)),!t){if(i.doctype!="Purchase Order"&&i.doc.customer||i.doc.party_name&&in_list(["Quotation","Opportunity"],i.doc.doctype)){let r="Customer";i.doc.quotation_to&&i.doc.quotation_to==="Lead"&&(r="Lead"),t={party:i.doc.customer||i.doc.party_name,party_type:r,price_list:i.doc.selling_price_list}}else i.doc.supplier&&(t={party:i.doc.supplier,party_type:"Supplier",bill_date:i.doc.bill_date,price_list:i.doc.buying_price_list});in_list(["Sales Invoice","Sales Order","Delivery Note"],i.doc.doctype)&&(t||(t={party:i.doc.customer||i.doc.party_name,party_type:"Customer"}),i.doc.company_address&&!t.company_address&&(t.company_address=i.doc.company_address),i.doc.shipping_address_name&&!t.shipping_address_name&&(t.shipping_address_name=i.doc.shipping_address_name)),in_list(["Purchase Invoice","Purchase Order","Purchase Receipt"],i.doc.doctype)&&(t||(t={party:i.doc.supplier,party_type:"Supplier"}),i.doc.shipping_address&&!t.shipping_address&&(t.shipping_address=i.doc.shipping_address)),t&&(t.posting_date=i.doc.posting_date||i.doc.transaction_date,t.fetch_payment_terms_template=cint(!i.doc.ignore_default_payment_terms_template))}!t||!t.party||frappe.meta.get_docfield(i.doc.doctype,"taxes")&&!erpnext.utils.validate_mandatory(i,"Posting / Transaction Date",t.posting_date,t.party_type=="Customer"?"customer":"supplier")||!erpnext.utils.validate_mandatory(i,"Company",i.doc.company,t.party_type=="Customer"?"customer":"supplier")||(t.currency=i.doc.currency,t.company=i.doc.company,t.doctype=i.doc.doctype,frappe.call({method:e,args:t,callback:function(r){r.message&&(i.supplier_tds=r.message.supplier_tds,i.updating_party_details=!0,frappe.run_serially([()=>i.set_value(r.message),()=>{i.updating_party_details=!1,a&&a(),i.refresh(),erpnext.utils.add_item(i)}]))}}))};erpnext.utils.add_item=function(i){if(i.is_new()){var e=frappe.get_prev_route();if(e[1]==="Item"&&!(i.doc.items&&i.doc.items.length)){var t=i.add_child("items");i.refresh_field("items"),frappe.model.set_value(t.doctype,t.name,"item_code",e[2])}}};erpnext.utils.get_address_display=function(i,e,t,a){if(!i.updating_party_details){if(!e)if(i.doctype!="Purchase Order"&&i.doc.customer)e="customer_address";else if(i.doc.supplier)e="supplier_address";else return;t||(t="address_display"),i.doc[e]?frappe.call({method:"frappe.contacts.doctype.address.address.get_address_display",args:{address_dict:i.doc[e]},callback:function(r){r.message&&i.set_value(t,r.message)}}):i.set_value(t,"")}};erpnext.utils.set_taxes_from_address=function(i,e,t,a){if(!i.updating_party_details){if(frappe.meta.get_docfield(i.doc.doctype,"taxes")){if(!erpnext.utils.validate_mandatory(i,"Lead / Customer / Supplier",i.doc.customer||i.doc.supplier||i.doc.lead||i.doc.party_name,e)||!erpnext.utils.validate_mandatory(i,"Posting / Transaction Date",i.doc.posting_date||i.doc.transaction_date,e))return}else return;frappe.call({method:"erpnext.accounts.party.get_address_tax_category",args:{tax_category:i.doc.tax_category,billing_address:i.doc[t],shipping_address:i.doc[a]},callback:function(r){r.exc||(i.doc.tax_category!=r.message?i.set_value("tax_category",r.message):erpnext.utils.set_taxes(i,e))}})}};erpnext.utils.set_taxes=function(i,e){if(frappe.meta.get_docfield(i.doc.doctype,"taxes")){if(!erpnext.utils.validate_mandatory(i,"Company",i.doc.company,e)||!erpnext.utils.validate_mandatory(i,"Lead / Customer / Supplier",i.doc.customer||i.doc.supplier||i.doc.lead||i.doc.party_name,e)||!erpnext.utils.validate_mandatory(i,"Posting / Transaction Date",i.doc.posting_date||i.doc.transaction_date,e))return}else return;var t,a;i.doc.lead?(t="Lead",a=i.doc.lead):i.doc.customer?(t="Customer",a=i.doc.customer):i.doc.supplier?(t="Supplier",a=i.doc.supplier):i.doc.quotation_to&&(t=i.doc.quotation_to,a=i.doc.party_name),i.doc.company||frappe.throw(__("Kindly select the company first")),frappe.call({method:"erpnext.accounts.party.set_taxes",args:{party:a,party_type:t,posting_date:i.doc.posting_date||i.doc.transaction_date,company:i.doc.company,customer_group:i.doc.customer_group,supplier_group:i.doc.supplier_group,tax_category:i.doc.tax_category,billing_address:i.doc.customer||i.doc.lead?i.doc.customer_address:i.doc.supplier_address,shipping_address:i.doc.shipping_address_name},callback:function(r){r.message&&i.set_value("taxes_and_charges",r.message)}})};erpnext.utils.get_contact_details=function(i){i.updating_party_details||i.doc.contact_person&&frappe.call({method:"frappe.contacts.doctype.contact.contact.get_contact_details",args:{contact:i.doc.contact_person},callback:function(e){e.message&&i.set_value(e.message)}})};erpnext.utils.validate_mandatory=function(i,e,t,a){return t?!0:(i.doc[a]="",refresh_field(a),frappe.throw({message:__("Please enter {0} first",[e]),title:__("Mandatory")}),!1)};erpnext.utils.get_shipping_address=function(i,e){if(i.doc.company){if((i.doc.inter_company_order_reference||i.doc.internal_invoice_reference||i.doc.internal_order_reference)&&e)return e();frappe.call({method:"erpnext.accounts.custom.address.get_shipping_address",args:{company:i.doc.company,address:i.doc.shipping_address},callback:function(t){if(t.message&&(i.set_value("shipping_address",t.message[0]),i.set_value("shipping_address_display",t.message[1])),e)return e()}})}else frappe.msgprint(__("Select company first"))};frappe.provide("erpnext.stock");erpnext.stock.StockController=class extends frappe.ui.form.Controller{onload(){this.frm.fields_dict.company&&this.setup_warehouse_query()}setup_warehouse_query(){var e=this;erpnext.queries.setup_queries(this.frm,"Warehouse",function(){return erpnext.queries.warehouse(e.frm.doc)})}setup_posting_date_time_check(){frappe.ui.form.on(this.frm.doctype,"set_posting_date_and_time_read_only",function(e){e.doc.docstatus==0&&e.doc.set_posting_time?(e.set_df_property("posting_date","read_only",0),e.set_df_property("posting_time","read_only",0)):(e.set_df_property("posting_date","read_only",1),e.set_df_property("posting_time","read_only",1))}),frappe.ui.form.on(this.frm.doctype,"set_posting_time",function(e){e.trigger("set_posting_date_and_time_read_only")}),frappe.ui.form.on(this.frm.doctype,"refresh",function(e){e.doc.docstatus==0&&(e.doc.posting_date||e.set_value("posting_date",frappe.datetime.nowdate()),e.doc.posting_time||e.set_value("posting_time",frappe.datetime.now_time()),e.trigger("set_posting_date_and_time_read_only"))})}show_stock_ledger(){var e=this;this.frm.doc.docstatus>0&&cur_frm.add_custom_button(__("Stock Ledger"),function(){frappe.route_options={voucher_no:e.frm.doc.name,from_date:e.frm.doc.posting_date,to_date:moment(e.frm.doc.modified).format("YYYY-MM-DD"),company:e.frm.doc.company,show_cancelled_entries:e.frm.doc.docstatus===2},frappe.set_route("query-report","Stock Ledger")},__("View"))}show_general_ledger(){var e=this;this.frm.doc.docstatus>0&&cur_frm.add_custom_button(__("Accounting Ledger"),function(){frappe.route_options={voucher_no:e.frm.doc.name,from_date:e.frm.doc.posting_date,to_date:moment(e.frm.doc.modified).format("YYYY-MM-DD"),company:e.frm.doc.company,group_by:"Group by Voucher (Consolidated)",show_cancelled_entries:e.frm.doc.docstatus===2},frappe.set_route("query-report","General Ledger")},__("View"))}};erpnext.payments=class extends erpnext.stock.StockController{make_payment(){var e=this;this.dialog=new frappe.ui.Dialog({title:"Payment"}),this.dialog.show(),this.$body=this.dialog.body,this.set_payment_primary_action(),this.make_keyboard(),this.select_text()}select_text(){$(this.$body).find(".form-control").click(function(){$(this).select()})}set_payment_primary_action(){var e=this;this.dialog.set_primary_action(__("Submit"),function(){$.each(e.frm.doc.payments,function(t,a){if(a.amount!=0){e.dialog.hide(),e.submit_invoice();return}})})}make_keyboard(){var e=this;$(this.$body).empty(),$(this.$body).html(frappe.render_template("pos_payment",this.frm.doc)),this.show_payment_details(),this.bind_keyboard_event(),this.clear_amount()}make_multimode_payment(){var e=this;this.frm.doc.change_amount>0&&(e.payment_val=e.doc.outstanding_amount),this.payments=frappe.model.add_child(this.frm.doc,"Multi Mode Payment","payments"),this.payments.mode_of_payment=this.dialog.fields_dict.mode_of_payment.get_value(),this.payments.amount=flt(this.payment_val)}show_payment_details(){var e=this,t=$(this.$body).find(".multimode-payments").empty();this.frm.doc.payments.length?$.each(this.frm.doc.payments,function(a,r){$(frappe.render_template("payment_details",{mode_of_payment:r.mode_of_payment,amount:r.amount,idx:r.idx,currency:e.frm.doc.currency,type:r.type})).appendTo(t),r.type=="Cash"&&r.amount==e.frm.doc.paid_amount&&(e.idx=r.idx,e.selected_mode=$(e.$body).find(repl("input[idx='%(idx)s']",{idx:e.idx})),e.highlight_selected_row(),e.bind_amount_change_event())}):$("<p>No payment mode selected in pos profile</p>").appendTo(t)}set_outstanding_amount(){this.selected_mode=$(this.$body).find(repl("input[idx='%(idx)s']",{idx:this.idx})),this.highlight_selected_row(),this.payment_val=0,this.frm.doc.outstanding_amount>0&&flt(this.selected_mode.val())==0?(this.payment_val=flt(this.frm.doc.outstanding_amount/this.frm.doc.conversion_rate,precision("outstanding_amount")),this.selected_mode.val(format_currency(this.payment_val,this.frm.doc.currency)),this.update_payment_amount()):flt(this.selected_mode.val())>0&&(this.payment_val=flt(this.selected_mode.val())),this.selected_mode.select(),this.bind_amount_change_event()}bind_keyboard_event(){var e=this;this.payment_val="",this.bind_form_control_event(),this.bind_numeric_keys_event()}bind_form_control_event(){var e=this;$(this.$body).find(".pos-payment-row").click(function(){e.idx=$(this).attr("idx"),e.set_outstanding_amount()}),$(this.$body).find(".form-control").click(function(){e.idx=$(this).attr("idx"),e.set_outstanding_amount(),e.update_paid_amount(!0)}),$(this.$body).find(".write_off_amount").change(function(){e.write_off_amount(flt($(this).val()),precision("write_off_amount"))}),$(this.$body).find(".change_amount").change(function(){e.change_amount(flt($(this).val()),precision("change_amount"))})}highlight_selected_row(){var e=$(this.$body).find(repl(".pos-payment-row[idx='%(idx)s']",{idx:this.idx}));$(this.$body).find(".pos-payment-row").removeClass("selected-payment-mode"),e.addClass("selected-payment-mode"),$(this.$body).find(".amount").attr("disabled",!0),this.selected_mode.attr("disabled",!1)}bind_numeric_keys_event(){var e=this;$(this.$body).find(".pos-keyboard-key").click(function(){e.payment_val+=$(this).text(),e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_paid_amount()}),$(this.$body).find(".delete-btn").click(function(){e.payment_val=cstr(flt(e.selected_mode.val())).slice(0,-1),e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_paid_amount()})}bind_amount_change_event(){var e=this;this.selected_mode.change(function(){e.payment_val=flt($(this).val())||0,e.selected_mode.val(format_currency(e.payment_val,e.frm.doc.currency)),e.idx=e.selected_mode.attr("idx"),e.update_payment_amount()})}clear_amount(){var e=this;$(this.$body).find(".clr").click(function(t){t.stopPropagation(),e.idx=$(this).attr("idx"),e.selected_mode=$(e.$body).find(repl("input[idx='%(idx)s']",{idx:e.idx})),e.payment_val=0,e.selected_mode.val(0),e.highlight_selected_row(),e.update_payment_amount()})}write_off_amount(e){this.frm.doc.write_off_amount=flt(e,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount")),this.calculate_outstanding_amount(!1),this.show_amounts()}change_amount(e){var t=this;this.frm.doc.change_amount=flt(e,precision("change_amount")),this.calculate_write_off_amount(),this.show_amounts()}update_paid_amount(e){var t=this;if(in_list(["change_amount","write_off_amount"],this.idx)){var a=t.selected_mode.val();t.idx=="change_amount"?t.change_amount(a):(flt(a)==0&&e&&t.frm.doc.outstanding_amount>0&&(a=flt(t.frm.doc.outstanding_amount/t.frm.doc.conversion_rate,precision(t.idx))),t.write_off_amount(a))}else this.update_payment_amount()}update_payment_amount(){var e=this;$.each(this.frm.doc.payments,function(t,a){cint(e.idx)==cint(a.idx)&&(a.amount=flt(e.selected_mode.val(),2))}),this.calculate_outstanding_amount(!1),this.show_amounts()}show_amounts(){var e=this;$(this.$body).find(".write_off_amount").val(format_currency(this.frm.doc.write_off_amount,this.frm.doc.currency)),$(this.$body).find(".paid_amount").text(format_currency(this.frm.doc.paid_amount,this.frm.doc.currency)),$(this.$body).find(".change_amount").val(format_currency(this.frm.doc.change_amount,this.frm.doc.currency)),$(this.$body).find(".outstanding_amount").text(format_currency(this.frm.doc.outstanding_amount,frappe.get_doc(":Company",this.frm.doc.company).default_currency)),this.update_invoice()}};erpnext.taxes_and_totals=class extends erpnext.payments{setup(){this.fetch_round_off_accounts()}apply_pricing_rule_on_item(e){let t=e.price_list_rate,a=e.rate;in_list(["Sales Order","Quotation"],e.parenttype)&&e.blanket_order_rate&&(t=e.blanket_order_rate),e.margin_type=="Percentage"?e.rate_with_margin=flt(t)+flt(t)*(flt(e.margin_rate_or_amount)/100):e.rate_with_margin=flt(t)+flt(e.margin_rate_or_amount),e.base_rate_with_margin=flt(e.rate_with_margin)*flt(this.frm.doc.conversion_rate),a=flt(e.rate_with_margin,precision("rate",e)),e.discount_percentage&&(e.discount_amount=flt(e.rate_with_margin)*flt(e.discount_percentage)/100),e.discount_amount&&(a=flt(e.rate_with_margin-e.discount_amount,precision("rate",e)),e.discount_percentage=100*flt(e.discount_amount)/flt(e.rate_with_margin)),frappe.model.set_value(e.doctype,e.name,"rate",a)}calculate_taxes_and_totals(e){this.discount_amount_applied=!1,this._calculate_taxes_and_totals(),this.calculate_discount_amount(),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype)&&this.frm.doc.docstatus<2&&!this.frm.doc.is_return&&this.calculate_total_advance(e),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_pos&&this.frm.doc.is_return&&(this.frm.doc.doctype=="Sales Invoice"&&this.set_total_amount_to_default_mop(),this.calculate_paid_amount()),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice"],this.frm.doc.doctype)&&(this.calculate_commission(),this.calculate_contribution()),this.frm.doc.doctype==="Purchase Invoice"&&this.frm.doc.is_return&&this.frm.doc.grand_total>this.frm.doc.paid_amount&&(this.frm.doc.paid_amount=flt(this.frm.doc.grand_total,precision("grand_total"))),this.frm.refresh_fields()}calculate_discount_amount(){frappe.meta.get_docfield(this.frm.doc.doctype,"discount_amount")&&(this.set_discount_amount(),this.apply_discount_amount())}_calculate_taxes_and_totals(){this.validate_conversion_rate(),this.calculate_item_values(),this.initialize_taxes(),this.determine_exclusive_rate(),this.calculate_net_total(),this.calculate_shipping_charges(),this.calculate_taxes(),this.manipulate_grand_total_for_inclusive_tax(),this.calculate_totals(),this._cleanup()}validate_conversion_rate(){this.frm.doc.conversion_rate=flt(this.frm.doc.conversion_rate,cur_frm?precision("conversion_rate"):9);var e=frappe.meta.get_label(this.frm.doc.doctype,"conversion_rate",this.frm.doc.name),t=this.get_company_currency();if(!this.frm.doc.conversion_rate)if(this.frm.doc.currency==t)this.frm.set_value("conversion_rate",1);else{let a=[e,this.frm.doc.currency,t],r=__("{0} is mandatory. Maybe Currency Exchange record is not created for {1} to {2}",a);frappe.throw(r)}}calculate_item_values(){var e=this;this.discount_amount_applied||$.each(this.frm.doc.items||[],function(t,a){frappe.model.round_floats_in(a),a.net_rate=a.rate,!a.qty&&e.frm.doc.is_return?a.amount=flt(a.rate*-1,precision("amount",a)):!a.qty&&e.frm.doc.is_debit_note?a.amount=flt(a.rate,precision("amount",a)):a.amount=flt(a.rate*a.qty,precision("amount",a)),a.net_amount=a.amount,a.item_tax_amount=0,a.total_weight=flt(a.weight_per_unit*a.stock_qty),e.set_in_company_currency(a,["price_list_rate","rate","amount","net_rate","net_amount"])})}set_in_company_currency(e,t){var a=this;$.each(t,function(r,s){e["base_"+s]=flt(flt(e[s],precision(s,e))*a.frm.doc.conversion_rate,precision("base_"+s,e))})}initialize_taxes(){var e=this;$.each(this.frm.doc.taxes||[],function(t,a){a.dont_recompute_tax||(a.item_wise_tax_detail={});var r=["total","tax_amount_after_discount_amount","tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];cstr(a.charge_type)!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&r.push("tax_amount"),$.each(r,function(s,n){a[n]=0}),!this.discount_amount_applied&&cur_frm&&(cur_frm.cscript.validate_taxes_and_charges(a.doctype,a.name),e.validate_inclusive_tax(a)),frappe.model.round_floats_in(a)})}fetch_round_off_accounts(){let e=this;if(frappe.flags.round_off_applicable_accounts=[],e.frm.doc.company)return frappe.call({method:"erpnext.controllers.taxes_and_totals.get_round_off_applicable_accounts",args:{company:e.frm.doc.company,account_list:frappe.flags.round_off_applicable_accounts},callback(t){t.message&&frappe.flags.round_off_applicable_accounts.push(...t.message)}})}determine_exclusive_rate(){var e=this,t=!1;$.each(e.frm.doc.taxes||[],function(a,r){cint(r.included_in_print_rate)&&(t=!0)}),t!=!1&&$.each(e.frm.doc.items||[],function(a,r){var s=e._load_item_tax_rate(r.item_tax_rate),n=0,l=0;if($.each(e.frm.doc.taxes||[],function(_,d){var p=e.get_current_tax_fraction(d,s);d.tax_fraction_for_current_item=p[0];var g=p[1];_==0?d.grand_total_fraction_for_current_item=1+d.tax_fraction_for_current_item:d.grand_total_fraction_for_current_item=e.frm.doc.taxes[_-1].grand_total_fraction_for_current_item+d.tax_fraction_for_current_item,n+=d.tax_fraction_for_current_item,l+=g*flt(r.qty)}),!e.discount_amount_applied&&r.qty&&(l||n)){var c=flt(r.amount)-l;r.net_amount=flt(c/(1+n)),r.net_rate=r.qty?flt(r.net_amount/r.qty,precision("net_rate",r)):0,e.set_in_company_currency(r,["net_rate","net_amount"])}})}get_current_tax_fraction(e,t){var a=0,r=0;if(cint(e.included_in_print_rate)){var s=this._get_tax_rate(e,t);e.charge_type=="On Net Total"?a=s/100:e.charge_type=="On Previous Row Amount"?a=s/100*this.frm.doc.taxes[cint(e.row_id)-1].tax_fraction_for_current_item:e.charge_type=="On Previous Row Total"?a=s/100*this.frm.doc.taxes[cint(e.row_id)-1].grand_total_fraction_for_current_item:e.charge_type=="On Item Quantity"&&(r=flt(s))}return e.add_deduct_tax&&e.add_deduct_tax=="Deduct"&&(a*=-1,r*=-1),[a,r]}_get_tax_rate(e,t){return Object.keys(t).indexOf(e.account_head)!=-1?flt(t[e.account_head],precision("rate",e)):e.rate}calculate_net_total(){var e=this;this.frm.doc.total_qty=this.frm.doc.total=this.frm.doc.base_total=this.frm.doc.net_total=this.frm.doc.base_net_total=0,$.each(this.frm.doc.items||[],function(t,a){e.frm.doc.total+=a.amount,e.frm.doc.total_qty+=a.qty,e.frm.doc.base_total+=a.base_amount,e.frm.doc.net_total+=a.net_amount,e.frm.doc.base_net_total+=a.base_net_amount})}calculate_shipping_charges(){frappe.model.round_floats_in(this.frm.doc,["total","base_total","net_total","base_net_total"]),frappe.meta.get_docfield(this.frm.doc.doctype,"shipping_rule",this.frm.doc.name)&&this.shipping_rule()}add_taxes_from_item_tax_template(e){let t=this;e&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&(typeof e=="string"&&(e=JSON.parse(e)),$.each(e,function(a,r){if(!(t.frm.doc.taxes||[]).find(n=>n.account_head===a)){let n=frappe.model.add_child(t.frm.doc,"taxes");n.charge_type="On Net Total",n.account_head=a,n.rate=0}}))}calculate_taxes(){var e=this;this.frm.doc.rounding_adjustment=0;var t={};$.each(this.frm.doc.taxes||[],function(a,r){r.charge_type=="Actual"&&(t[r.idx]=flt(r.tax_amount,precision("tax_amount",r)))}),$.each(this.frm.doc.items||[],function(a,r){var s=e._load_item_tax_rate(r.item_tax_rate);$.each(e.frm.doc.taxes||[],function(n,l){var c=e.get_current_tax_amount(r,l,s);l.charge_type=="Actual"&&(t[l.idx]-=c,a==e.frm.doc.items.length-1&&(c+=t[l.idx])),l.charge_type!="Actual"&&!(e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total")&&(l.tax_amount+=c),l.tax_amount_for_current_item=c,l.tax_amount_after_discount_amount+=c,l.category&&(c=l.category=="Valuation"?0:c,c*=l.add_deduct_tax=="Deduct"?-1:1),n==0?l.grand_total_for_current_item=flt(r.net_amount+c):l.grand_total_for_current_item=flt(e.frm.doc.taxes[n-1].grand_total_for_current_item+c),a==e.frm.doc.items.length-1&&(e.round_off_totals(l),e.set_in_company_currency(l,["tax_amount","tax_amount_after_discount_amount"]),e.round_off_base_values(l),e.set_cumulative_total(n,l),e.set_in_company_currency(l,["total"]),n==e.frm.doc.taxes.length-1&&e.discount_amount_applied&&e.frm.doc.apply_discount_on=="Grand Total"&&e.frm.doc.discount_amount&&(e.frm.doc.rounding_adjustment=flt(e.frm.doc.grand_total-flt(e.frm.doc.discount_amount)-l.total,precision("rounding_adjustment"))))})})}set_cumulative_total(e,t){var a=t.tax_amount_after_discount_amount;t.category=="Valuation"&&(a=0),t.add_deduct_tax=="Deduct"&&(a=-1*a),e==0?t.total=flt(this.frm.doc.net_total+a,precision("total",t)):t.total=flt(this.frm.doc.taxes[e-1].total+a,precision("total",t))}_load_item_tax_rate(e){return e?JSON.parse(e):{}}get_current_tax_amount(e,t,a){var r=this._get_tax_rate(t,a),s=0;if(["On Previous Row Amount","On Previous Row Total"].includes(t.charge_type)&&(t.idx===1&&frappe.throw(__("Cannot select charge type as 'On Previous Row Amount' or 'On Previous Row Total' for first row")),t.row_id||(t.row_id=t.idx-1)),t.charge_type=="Actual"){var n=flt(t.tax_amount,precision("tax_amount",t));s=this.frm.doc.net_total?e.net_amount/this.frm.doc.net_total*n:0}else t.charge_type=="On Net Total"?s=r/100*e.net_amount:t.charge_type=="On Previous Row Amount"?s=r/100*this.frm.doc.taxes[cint(t.row_id)-1].tax_amount_for_current_item:t.charge_type=="On Previous Row Total"?s=r/100*this.frm.doc.taxes[cint(t.row_id)-1].grand_total_for_current_item:t.charge_type=="On Item Quantity"&&(s=r*e.qty);return t.dont_recompute_tax||this.set_item_wise_tax(e,t,r,s),s}set_item_wise_tax(e,t,a,r){let s=t.item_wise_tax_detail,n=e.item_code||e.item_name;typeof s=="string"&&(t.item_wise_tax_detail=JSON.parse(t.item_wise_tax_detail),s=t.item_wise_tax_detail);let l=r*this.frm.doc.conversion_rate;s&&s[n]&&(l+=s[n][1]),s[n]=[a,flt(l,precision("base_tax_amount",t))]}round_off_totals(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.tax_amount=Math.round(e.tax_amount),e.tax_amount_after_discount_amount=Math.round(e.tax_amount_after_discount_amount)),e.tax_amount=flt(e.tax_amount,precision("tax_amount",e)),e.tax_amount_after_discount_amount=flt(e.tax_amount_after_discount_amount,precision("tax_amount",e))}round_off_base_values(e){frappe.flags.round_off_applicable_accounts.includes(e.account_head)&&(e.base_tax_amount=Math.round(e.base_tax_amount),e.base_tax_amount_after_discount_amount=Math.round(e.base_tax_amount_after_discount_amount))}manipulate_grand_total_for_inclusive_tax(){var e=this;if(this.frm.doc.taxes&&this.frm.doc.taxes.length){var t=!1;if($.each(this.frm.doc.taxes||[],function(n,l){cint(l.included_in_print_rate)&&(t=!0)}),t){var a=e.frm.doc.taxes.slice(-1)[0],r=frappe.utils.sum($.map(this.frm.doc.taxes||[],function(n){if(!n.included_in_print_rate)return flt(n.tax_amount_after_discount_amount)})),s=e.frm.doc.total+r-flt(a.total,precision("grand_total"));e.discount_amount_applied&&e.frm.doc.discount_amount&&(s-=flt(e.frm.doc.discount_amount)),s=flt(s,precision("rounding_adjustment")),s&&Math.abs(s)<=5/Math.pow(10,precision("tax_amount",a))&&(e.frm.doc.rounding_adjustment=s)}}}calculate_totals(){var e=this,t=this.frm.doc.taxes?this.frm.doc.taxes.length:0;this.frm.doc.grand_total=flt(t?this.frm.doc.taxes[t-1].total+flt(this.frm.doc.rounding_adjustment):this.frm.doc.net_total),in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","POS Invoice"],this.frm.doc.doctype)?this.frm.doc.base_grand_total=this.frm.doc.total_taxes_and_charges?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total:(this.frm.doc.taxes_and_charges_added=this.frm.doc.taxes_and_charges_deducted=0,t&&($.each(this.frm.doc.taxes||[],function(a,r){in_list(["Valuation and Total","Total"],r.category)&&(r.add_deduct_tax=="Add"?e.frm.doc.taxes_and_charges_added+=flt(r.tax_amount_after_discount_amount):e.frm.doc.taxes_and_charges_deducted+=flt(r.tax_amount_after_discount_amount))}),frappe.model.round_floats_in(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.base_grand_total=flt(this.frm.doc.taxes_and_charges_added||this.frm.doc.taxes_and_charges_deducted?flt(this.frm.doc.grand_total*this.frm.doc.conversion_rate):this.frm.doc.base_net_total),this.set_in_company_currency(this.frm.doc,["taxes_and_charges_added","taxes_and_charges_deducted"])),this.frm.doc.total_taxes_and_charges=flt(this.frm.doc.grand_total-this.frm.doc.net_total-flt(this.frm.doc.rounding_adjustment),precision("total_taxes_and_charges")),this.set_in_company_currency(this.frm.doc,["total_taxes_and_charges","rounding_adjustment"]),frappe.model.round_floats_in(this.frm.doc,["grand_total","base_grand_total"]),this.set_rounded_total()}set_rounded_total(){var e=0;if(frappe.meta.get_docfield(this.frm.doc.doctype,"disable_rounded_total",this.frm.doc.name)?e=this.frm.doc.disable_rounded_total:frappe.sys_defaults.disable_rounded_total&&(e=frappe.sys_defaults.disable_rounded_total),cint(e)){this.frm.doc.rounded_total=0,this.frm.doc.base_rounded_total=0;return}frappe.meta.get_docfield(this.frm.doc.doctype,"rounded_total",this.frm.doc.name)&&(this.frm.doc.rounded_total=round_based_on_smallest_currency_fraction(this.frm.doc.grand_total,this.frm.doc.currency,precision("rounded_total")),this.frm.doc.rounding_adjustment+=flt(this.frm.doc.rounded_total-this.frm.doc.grand_total,precision("rounding_adjustment")),this.set_in_company_currency(this.frm.doc,["rounding_adjustment","rounded_total"]))}_cleanup(){if(this.frm.doc.base_in_words=this.frm.doc.in_words="",this.frm.doc.items&&this.frm.doc.items.length&&(frappe.meta.get_docfield(this.frm.doc.items[0].doctype,"item_tax_amount",this.frm.doctype)||$.each(this.frm.doc.items||[],function(t,a){delete a.item_tax_amount})),this.frm.doc.taxes&&this.frm.doc.taxes.length){var e=["tax_amount_for_current_item","grand_total_for_current_item","tax_fraction_for_current_item","grand_total_fraction_for_current_item"];frappe.meta.get_docfield(this.frm.doc.taxes[0].doctype,"tax_amount_after_discount_amount",this.frm.doctype)||e.push("tax_amount_after_discount_amount"),$.each(this.frm.doc.taxes||[],function(t,a){$.each(e,function(r,s){delete a[s]}),a.dont_recompute_tax||(a.item_wise_tax_detail=JSON.stringify(a.item_wise_tax_detail))})}}set_discount_amount(){this.frm.doc.additional_discount_percentage&&(this.frm.doc.discount_amount=flt(flt(this.frm.doc[frappe.scrub(this.frm.doc.apply_discount_on)])*this.frm.doc.additional_discount_percentage/100,precision("discount_amount")))}apply_discount_amount(){var e=this,t=0;if(this.frm.doc.base_discount_amount=0,this.frm.doc.discount_amount){this.frm.doc.apply_discount_on||frappe.throw(__("Please select Apply Discount On")),this.frm.doc.base_discount_amount=flt(this.frm.doc.discount_amount*this.frm.doc.conversion_rate,precision("base_discount_amount"));var a=this.get_total_for_discount_amount(),r=0;a&&($.each(this.frm.doc.items||[],function(s,n){if(t=flt(e.frm.doc.discount_amount)*n.net_amount/a,n.net_amount=flt(n.net_amount-t,precision("base_amount",n)),r+=n.net_amount,(!(e.frm.doc.taxes||[]).length||a==e.frm.doc.net_total||e.frm.doc.apply_discount_on=="Net Total")&&s==(e.frm.doc.items||[]).length-1){var l=flt(e.frm.doc.net_total-r-e.frm.doc.discount_amount,precision("net_total"));n.net_amount=flt(n.net_amount+l,precision("net_amount",n))}n.net_rate=n.qty?flt(n.net_amount/n.qty,precision("net_rate",n)):0,e.set_in_company_currency(n,["net_rate","net_amount"])}),this.discount_amount_applied=!0,this._calculate_taxes_and_totals())}}get_total_for_discount_amount(){if(this.frm.doc.apply_discount_on=="Net Total")return this.frm.doc.net_total;var e=0,t={};return $.each(this.frm.doc.taxes||[],function(a,r){if(in_list(["Actual","On Item Quantity"],r.charge_type)){var s=r.category=="Valuation"?0:r.tax_amount;s*=r.add_deduct_tax=="Deduct"?-1:1,t[r.idx]=s}else if(t[r.row_id]!==null){var n=flt(t[r.row_id])*flt(r.rate)/100;t[r.idx]=n}}),$.each(t,function(a,r){r&&(e+=r)}),flt(this.frm.doc.grand_total-e,precision("grand_total"))}calculate_total_advance(e){var t=frappe.utils.sum($.map(this.frm.doc.advances||[],function(a){return flt(a.allocated_amount,precision("allocated_amount",a))}));this.frm.doc.total_advance=flt(t,precision("total_advance")),this.calculate_outstanding_amount(e)}is_internal_invoice(){return!!(["Sales Invoice","Purchase Invoice"].includes(this.frm.doc.doctype)&&this.frm.doc.company===this.frm.doc.represents_company)}calculate_outstanding_amount(e){if(in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.is_return&&this.calculate_paid_amount(),!(this.frm.doc.is_return||this.frm.doc.docstatus>0||this.is_internal_invoice())&&(frappe.model.round_floats_in(this.frm.doc,["grand_total","total_advance","write_off_amount"]),in_list(["Sales Invoice","POS Invoice","Purchase Invoice"],this.frm.doc.doctype))){let r=this.frm.doc.rounded_total||this.frm.doc.grand_total,s=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var t=flt(r-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var t=flt(flt(s,precision("base_grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));if(frappe.model.round_floats_in(this.frm.doc,["paid_amount"]),this.set_in_company_currency(this.frm.doc,["paid_amount"]),this.frm.refresh_field&&(this.frm.refresh_field("paid_amount"),this.frm.refresh_field("base_paid_amount")),in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)){let n=this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount?flt(t-this.frm.doc.loyalty_amount,precision("base_grand_total")):t;this.set_default_payment(n,e),this.calculate_paid_amount()}this.calculate_change_amount();var a=this.frm.doc.party_account_currency==this.frm.doc.currency?this.frm.doc.paid_amount:this.frm.doc.base_paid_amount;this.frm.doc.outstanding_amount=flt(t-flt(a)+flt(this.frm.doc.change_amount*this.frm.doc.conversion_rate),precision("outstanding_amount"))}}set_total_amount_to_default_mop(){let e=this.frm.doc.rounded_total||this.frm.doc.grand_total,t=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;if(this.frm.doc.party_account_currency==this.frm.doc.currency)var a=flt(e-this.frm.doc.total_advance-this.frm.doc.write_off_amount,precision("grand_total"));else var a=flt(flt(t,precision("base_grand_total"))-this.frm.doc.total_advance-this.frm.doc.base_write_off_amount,precision("base_grand_total"));this.frm.doc.payments.find(r=>{r.default&&(r.amount=a)}),this.frm.refresh_fields()}set_default_payment(e,t){var a=this,r=!0;this.frm.doc.is_pos&&(t===void 0||t)&&$.each(this.frm.doc.payments||[],function(s,n){if(n.default&&r&&e>0){let l=flt(e,precision("base_amount",n));frappe.model.set_value(n.doctype,n.name,"base_amount",l);let c=flt(e/a.frm.doc.conversion_rate,precision("amount",n));frappe.model.set_value(n.doctype,n.name,"amount",c),r=!1}else a.frm.doc.paid_amount&&frappe.model.set_value(n.doctype,n.name,"amount",0)})}calculate_paid_amount(){var e=this,t=0,a=0;this.frm.doc.is_pos?$.each(this.frm.doc.payments||[],function(r,s){s.base_amount=flt(s.amount*e.frm.doc.conversion_rate,precision("base_amount",s)),t+=s.amount,a+=s.base_amount}):this.frm.doc.is_return||(this.frm.doc.payments=[]),this.frm.doc.redeem_loyalty_points&&this.frm.doc.loyalty_amount&&(a+=this.frm.doc.loyalty_amount,t+=flt(this.frm.doc.loyalty_amount/e.frm.doc.conversion_rate,precision("paid_amount"))),this.frm.set_value("paid_amount",flt(t,precision("paid_amount"))),this.frm.set_value("base_paid_amount",flt(a,precision("base_paid_amount")))}calculate_change_amount(){if(this.frm.doc.change_amount=0,this.frm.doc.base_change_amount=0,in_list(["Sales Invoice","POS Invoice"],this.frm.doc.doctype)&&this.frm.doc.paid_amount>this.frm.doc.grand_total&&!this.frm.doc.is_return){var e=$.map(this.frm.doc.payments,function(r){return r.type});if(in_list(e,"Cash")){var t=this.frm.doc.rounded_total||this.frm.doc.grand_total,a=this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total;this.frm.doc.change_amount=flt(this.frm.doc.paid_amount-t+this.frm.doc.write_off_amount,precision("change_amount")),this.frm.doc.base_change_amount=flt(this.frm.doc.base_paid_amount-a+this.frm.doc.base_write_off_amount,precision("base_change_amount"))}}}calculate_write_off_amount(){this.frm.doc.paid_amount>this.frm.doc.grand_total?(this.frm.doc.write_off_amount=flt(this.frm.doc.grand_total-this.frm.doc.paid_amount+this.frm.doc.change_amount,precision("write_off_amount")),this.frm.doc.base_write_off_amount=flt(this.frm.doc.write_off_amount*this.frm.doc.conversion_rate,precision("base_write_off_amount"))):this.frm.doc.paid_amount=0,this.calculate_outstanding_amount(!1)}};frappe.provide("erpnext.accounts.dimensions");erpnext.TransactionController=class extends erpnext.taxes_and_totals{setup(){super.setup();let e=this;frappe.flags.hide_serial_batch_dialog=!0,frappe.ui.form.on(this.frm.doctype+" Item","rate",function(a,r,s){var n=frappe.get_doc(r,s),l=frappe.meta.has_field(r,"margin_type");frappe.model.round_floats_in(n,["rate","price_list_rate"]),n.price_list_rate?n.rate>n.price_list_rate&&l?(n.discount_percentage=0,n.margin_type="Amount",n.margin_rate_or_amount=flt(n.rate-n.price_list_rate,precision("margin_rate_or_amount",n)),n.rate_with_margin=n.rate):(n.discount_percentage=flt((1-n.rate/n.price_list_rate)*100,precision("discount_percentage",n)),n.discount_amount=flt(n.price_list_rate)-flt(n.rate),n.margin_type="",n.margin_rate_or_amount=0,n.rate_with_margin=0):(n.discount_percentage=0,n.margin_type="",n.margin_rate_or_amount=0,n.rate_with_margin=0),n.base_rate_with_margin=n.rate_with_margin*flt(a.doc.conversion_rate),cur_frm.cscript.set_gross_profit(n),cur_frm.cscript.calculate_taxes_and_totals(),cur_frm.cscript.calculate_stock_uom_rate(a,r,s)}),frappe.ui.form.on(this.frm.cscript.tax_table,"rate",function(a,r,s){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"tax_amount",function(a,r,s){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"row_id",function(a,r,s){cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.cscript.tax_table,"included_in_print_rate",function(a,r,s){cur_frm.cscript.set_dynamic_labels(),cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"apply_discount_on",function(a){a.doc.additional_discount_percentage?a.trigger("additional_discount_percentage"):cur_frm.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype,"additional_discount_percentage",function(a){if(!a.doc.apply_discount_on){frappe.msgprint(__("Please set 'Apply Additional Discount On'"));return}a.via_discount_percentage=!0,a.doc.additional_discount_percentage&&a.doc.discount_amount&&(a.doc.discount_amount=0,a.cscript.calculate_taxes_and_totals());var r=flt(a.doc[frappe.model.scrub(a.doc.apply_discount_on)]),s=flt(r*flt(a.doc.additional_discount_percentage)/100,precision("discount_amount"));a.set_value("discount_amount",s).then(()=>delete a.via_discount_percentage)}),frappe.ui.form.on(this.frm.doctype,"discount_amount",function(a){a.cscript.set_dynamic_labels(),a.via_discount_percentage||(a.doc.additional_discount_percentage=0),a.cscript.calculate_taxes_and_totals()}),frappe.ui.form.on(this.frm.doctype+" Item",{items_add:function(a,r,s){var n=frappe.get_doc(r,s);!n.warehouse&&a.doc.set_warehouse&&(n.warehouse=a.doc.set_warehouse),!n.target_warehouse&&a.doc.set_target_warehouse&&(n.target_warehouse=a.doc.set_target_warehouse),!n.from_warehouse&&a.doc.set_from_warehouse&&(n.from_warehouse=a.doc.set_from_warehouse),erpnext.accounts.dimensions.copy_dimension_from_first_row(a,r,s,"items")}}),this.frm.fields_dict.items.grid.get_field("batch_no")&&this.frm.set_query("batch_no","items",function(a,r,s){return e.set_query_for_batch(a,r,s)}),this.frm.docstatus<2&&this.frm.fields_dict.payment_terms_template&&this.frm.fields_dict.payment_schedule&&this.frm.doc.payment_terms_template&&!this.frm.doc.payment_schedule.length&&this.frm.trigger("payment_terms_template"),this.frm.fields_dict.taxes&&(this.taxes_remove=this.calculate_taxes_and_totals),this.frm.fields_dict.items&&(this.items_remove=this.calculate_net_weight),this.frm.fields_dict.recurring_print_format&&this.frm.set_query("recurring_print_format",function(a){return{filters:[["Print Format","doc_type","=",cur_frm.doctype]]}}),this.frm.fields_dict.return_against&&this.frm.set_query("return_against",function(a){var r={docstatus:1,is_return:0,company:a.company};return e.frm.fields_dict.customer&&a.customer&&(r.customer=a.customer),e.frm.fields_dict.supplier&&a.supplier&&(r.supplier=a.supplier),{filters:r}}),this.frm.fields_dict.items.grid.get_field("expense_account")&&this.frm.set_query("expense_account","items",function(a){return{filters:{company:a.company}}}),frappe.meta.get_docfield(this.frm.doc.doctype,"pricing_rules")&&this.frm.set_indicator_formatter("pricing_rule",function(a){return a.rule_applied?"green":"red"});let t=this.frm.get_docfield("items","batch_no");t&&(t.get_route_options_for_new_doc=function(a){return{item:a.doc.item_code}}),this.frm.fields_dict.items.grid.get_field("blanket_order")&&this.frm.set_query("blanket_order","items",function(a,r,s){var n=locals[r][s];return{query:"erpnext.controllers.queries.get_blanket_orders",filters:{company:a.company,blanket_order_type:a.doctype==="Sales Order"?"Selling":"Purchasing",item:n.item_code}}}),this.frm.fields_dict.taxes_and_charges&&this.frm.set_query("taxes_and_charges",function(){return{filters:[["company","=",e.frm.doc.company],["docstatus","!=",2]]}})}onload(){var e=this;if(this.frm.doc.__islocal){var t=frappe.defaults.get_user_default("currency");let a=(r,s)=>{if(e.frm.fields_dict[r]&&!e.frm.doc[r])return e.frm.set_value(r,s)};return this.frm.trigger("set_default_internal_warehouse"),frappe.run_serially([()=>a("currency",t),()=>a("price_list_currency",t),()=>a("status","Draft"),()=>a("is_subcontracted","No"),()=>{this.frm.doc.company&&!this.frm.doc.amended_from&&this.frm.trigger("company")}])}}is_return(){!this.frm.doc.is_return&&this.frm.doc.return_against&&this.frm.set_value("return_against","")}setup_quality_inspection(){if(!in_list(["Delivery Note","Sales Invoice","Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype))return;let e=this;!this.frm.is_new()&&this.frm.doc.docstatus===0&&(this.frm.add_custom_button(__("Quality Inspection(s)"),()=>{e.make_quality_inspection()},__("Create")),this.frm.page.set_inner_btn_group_as_primary(__("Create")));let t=in_list(["Purchase Receipt","Purchase Invoice"],this.frm.doc.doctype)?"Incoming":"Outgoing",a=this.frm.get_docfield("items","quality_inspection");a.get_route_options_for_new_doc=function(r){if(!e.frm.is_new())return{inspection_type:t,reference_type:e.frm.doc.doctype,reference_name:e.frm.doc.name,item_code:r.doc.item_code,description:r.doc.description,item_serial_no:r.doc.serial_no?r.doc.serial_no.split(`
`)[0]:null,batch_no:r.doc.batch_no}},this.frm.set_query("quality_inspection","items",function(r,s,n){let l=locals[s][n];return{filters:{docstatus:1,inspection_type:t,reference_name:r.name,item_code:l.item_code}}})}make_payment_request(){var e=this;let t=in_list(["Sales Order","Sales Invoice"],this.frm.doc.doctype)?"Inward":"Outward";frappe.call({method:"erpnext.accounts.doctype.payment_request.payment_request.make_payment_request",args:{dt:e.frm.doc.doctype,dn:e.frm.doc.name,recipient_id:e.frm.doc.contact_email,payment_request_type:t,party_type:t=="Outward"?"Supplier":"Customer",party:t=="Outward"?e.frm.doc.supplier:e.frm.doc.customer},callback:function(a){if(!a.exc){var r=frappe.model.sync(a.message);frappe.set_route("Form",a.message.doctype,a.message.name)}}})}onload_post_render(){this.frm.doc.__islocal&&!(this.frm.doc.taxes||[]).length&&!(this.frm.doc.__onload&&this.frm.doc.__onload.load_after_mapping)?frappe.after_ajax(()=>this.apply_default_taxes()):this.frm.doc.__islocal&&this.frm.doc.company&&this.frm.doc.items&&!this.frm.doc.is_pos&&frappe.after_ajax(()=>this.calculate_taxes_and_totals()),frappe.meta.get_docfield(this.frm.doc.doctype+" Item","item_code")&&(this.setup_item_selector(),this.frm.get_field("items").grid.set_multiple_add("item_code","qty"))}refresh(){erpnext.toggle_naming_series(),erpnext.hide_company(),this.set_dynamic_labels(),this.setup_sms(),this.setup_quality_inspection()}scan_barcode(){let e=this;return this.frm.doc.scan_barcode&&frappe.call({method:"erpnext.selling.page.point_of_sale.point_of_sale.search_for_serial_or_batch_or_barcode_number",args:{search_value:this.frm.doc.scan_barcode}}).then(t=>{let a=t&&t.message;if(!a||Object.keys(a).length===0){frappe.show_alert({message:__("Cannot find Item with this Barcode"),indicator:"red"});return}e.modify_table_after_scan(a)}),!1}modify_table_after_scan(e){let t=this.frm.fields_dict.scan_barcode,a=this.frm.fields_dict.items.grid,r=null;Boolean(e.batch_no)&&frappe.meta.has_field(a.doctype,"batch_no")?r=this.get_batch_row_to_modify(e.batch_no):r=this.get_row_to_modify_on_scan(r,e),r||(r=frappe.model.add_child(this.frm.doc,a.doctype,"items")),this.show_scan_message(r.idx,r.item_code),this.set_scanned_values(r,e,t)}set_scanned_values(e,t,a){this.frm.from_barcode=this.frm.from_barcode?this.frm.from_barcode+1:1,frappe.model.set_value(e.doctype,e.name,{item_code:t.item_code,qty:(e.qty||0)+1}),["serial_no","batch_no","barcode"].forEach(r=>{if(t[r]&&frappe.meta.has_field(e.doctype,r)){let s=e[r]&&r==="serial_no",n=t[r];s&&(n=e[r]+`
`+t[r]),frappe.model.set_value(e.doctype,e.name,r,n)}}),a.set_value(""),refresh_field("items")}get_row_to_modify_on_scan(e,t){let a=this.frm.doc.items.find(s=>s.item_code===t.item_code),r=this.frm.doc.items.find(s=>!s.item_code);return a?e=a:r&&(e=r),e}get_batch_row_to_modify(e){return this.frm.doc.items.find(a=>a.batch_no===e)||null}show_scan_message(e,t=null){t?frappe.show_alert({message:__("Row #{0}: Qty increased by 1",[e]),indicator:"green"}):frappe.show_alert({message:__("Row #{0}: Item added",[e]),indicator:"green"})}apply_default_taxes(){var e=this,t=frappe.meta.get_docfield(e.frm.doc.doctype,"taxes_and_charges",e.frm.doc.name);if(!(!this.frm.doc.taxes_and_charges&&this.frm.doc.taxes&&this.frm.doc.taxes.length>0)&&t)return frappe.call({method:"erpnext.controllers.accounts_controller.get_default_taxes_and_charges",args:{master_doctype:t.options,tax_template:e.frm.doc.taxes_and_charges||"",company:e.frm.doc.company},debounce:2e3,callback:function(a){!a.exc&&a.message&&frappe.run_serially([()=>{a.message.taxes_and_charges&&(e.frm.doc.taxes_and_charges=a.message.taxes_and_charges),a.message.taxes&&e.frm.set_value("taxes",a.message.taxes)},()=>e.set_dynamic_labels(),()=>e.calculate_taxes_and_totals()])}})}setup_sms(){var e=this;let t=["Purchase Invoice","BOM"];this.frm.doc.docstatus===1&&!in_list(["Lost","Stopped","Closed"],this.frm.doc.status)&&!t.includes(this.frm.doctype)&&this.frm.page.add_menu_item(__("Send SMS"),function(){e.send_sms()})}send_sms(){var e=new erpnext.SMSManager(this.frm.doc)}barcode(e,t,a){var r=locals[t][a];(r.barcode==""||r.barcode==null)&&(r.item_code=""),this.frm.from_barcode=this.frm.from_barcode?this.frm.from_barcode+1:1,this.item_code(e,t,a)}item_code(e,t,a){var r=this,s=frappe.get_doc(t,a),n=0,l=0;if(s.weight_per_unit=0,s.weight_uom="",["Sales Invoice"].includes(this.frm.doc.doctype)?(n=cint(r.frm.doc.update_stock),l=n):(this.frm.doc.doctype==="Purchase Receipt"&&r.frm.doc.is_return||this.frm.doc.doctype==="Delivery Note")&&(l=1),this.frm.from_barcode==0&&(s.barcode=null),this.frm.from_barcode=this.frm.from_barcode-1>=0?this.frm.from_barcode-1:0,s.item_code||s.barcode||s.serial_no)if(!this.validate_company_and_party())this.frm.fields_dict.items.grid.grid_rows[s.idx-1].remove();else return this.frm.call({method:"erpnext.stock.get_item_details.get_item_details",child:s,args:{doc:r.frm.doc,args:{item_code:s.item_code,barcode:s.barcode,serial_no:s.serial_no,batch_no:s.batch_no,set_warehouse:r.frm.doc.set_warehouse,warehouse:s.warehouse,customer:r.frm.doc.customer||r.frm.doc.party_name,quotation_to:r.frm.doc.quotation_to,supplier:r.frm.doc.supplier,currency:r.frm.doc.currency,update_stock:n,conversion_rate:r.frm.doc.conversion_rate,price_list:r.frm.doc.selling_price_list||r.frm.doc.buying_price_list,price_list_currency:r.frm.doc.price_list_currency,plc_conversion_rate:r.frm.doc.plc_conversion_rate,company:r.frm.doc.company,order_type:r.frm.doc.order_type,is_pos:cint(r.frm.doc.is_pos),is_return:cint(r.frm.doc.is_return),is_subcontracted:r.frm.doc.is_subcontracted,transaction_date:r.frm.doc.transaction_date||r.frm.doc.posting_date,ignore_pricing_rule:r.frm.doc.ignore_pricing_rule,doctype:r.frm.doc.doctype,name:r.frm.doc.name,project:s.project||r.frm.doc.project,qty:s.qty||1,net_rate:s.rate,stock_qty:s.stock_qty,conversion_factor:s.conversion_factor,weight_per_unit:s.weight_per_unit,weight_uom:s.weight_uom,manufacturer:s.manufacturer,stock_uom:s.stock_uom,pos_profile:cint(r.frm.doc.is_pos)?r.frm.doc.pos_profile:"",cost_center:s.cost_center,tax_category:r.frm.doc.tax_category,item_tax_template:s.item_tax_template,child_docname:s.name}},callback:function(c){c.exc||frappe.run_serially([()=>{var _=locals[t][a];r.add_taxes_from_item_tax_template(_.item_tax_rate),_.free_item_data&&r.apply_product_discount(_)},()=>{r.frm.doc.is_internal_customer||r.frm.doc.is_internal_supplier?r.get_incoming_rate(s,r.frm.posting_date,r.frm.posting_time,r.frm.doc.doctype,r.frm.doc.company):r.frm.script_manager.trigger("price_list_rate",t,a)},()=>{(r.frm.doc.is_internal_customer||r.frm.doc.is_internal_supplier)&&r.calculate_taxes_and_totals()},()=>r.toggle_conversion_factor(s),()=>{if(l)return frappe.db.get_value("Item",s.item_code,["has_batch_no","has_serial_no"]).then(_=>{_.message&&(_.message.has_batch_no||_.message.has_serial_no)&&(frappe.flags.hide_serial_batch_dialog=!1)})},()=>{if(l&&!frappe.flags.hide_serial_batch_dialog)return frappe.db.get_single_value("Stock Settings","disable_serial_no_and_batch_selector").then(_=>{_&&(frappe.flags.hide_serial_batch_dialog=!0)})},()=>{if(l&&!frappe.flags.hide_serial_batch_dialog){var _=locals[t][a];$.each(c.message,function(d,p){_[d]||(_[d]=p)}),_.has_batch_no&&_.has_serial_no&&(_.batch_no=void 0),erpnext.show_serial_batch_selector(r.frm,_,d=>{r.frm.script_manager.trigger("qty",d.doctype,d.name),r.frm.doc.set_warehouse||r.frm.script_manager.trigger("warehouse",d.doctype,d.name),r.apply_price_list(d,!0)},void 0,!frappe.flags.hide_serial_batch_dialog)}},()=>r.conversion_factor(e,t,a,!0),()=>r.remove_pricing_rule(s),()=>{if(s.apply_rule_on_other_items){let _=s.name;r.apply_rule_on_other_items({key:s})}},()=>{var _=r.get_company_currency();r.update_item_grid_labels(_)}])}})}price_list_rate(e,t,a){var r=frappe.get_doc(t,a);frappe.model.round_floats_in(r,["price_list_rate","discount_percentage"]),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","POS Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item"]),t?this.apply_pricing_rule_on_item(r):r.rate=flt(r.price_list_rate*(1-r.discount_percentage/100),precision("rate",r)),this.calculate_taxes_and_totals()}margin_rate_or_amount(e,t,a){let r=frappe.get_doc(t,a);this.apply_pricing_rule_on_item(r),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()}margin_type(e,t,a){let r=frappe.get_doc(t,a);r.margin_type?(this.apply_pricing_rule_on_item(r,e,t,a),this.calculate_taxes_and_totals(),cur_frm.refresh_fields()):frappe.model.set_value(t,a,"margin_rate_or_amount",0)}get_incoming_rate(e,t,a,r,s){let n={item_code:e.item_code,warehouse:in_list("Purchase Receipt","Purchase Invoice")?e.from_warehouse:e.warehouse,posting_date:t,posting_time:a,qty:e.qty*e.conversion_factor,serial_no:e.serial_no,voucher_type:r,company:s,allow_zero_valuation_rate:e.allow_zero_valuation_rate};frappe.call({method:"erpnext.stock.utils.get_incoming_rate",args:{args:n},callback:function(l){frappe.model.set_value(e.doctype,e.name,"rate",l.message*e.conversion_factor)}})}add_taxes_from_item_tax_template(e){let t=this;e&&cint(frappe.defaults.get_default("add_taxes_from_item_tax_template"))&&(typeof e=="string"&&(e=JSON.parse(e)),$.each(e,function(a,r){if(!(t.frm.doc.taxes||[]).find(n=>n.account_head===a)){let n=frappe.model.add_child(t.frm.doc,"taxes");n.charge_type="On Net Total",n.account_head=a,n.rate=0}}))}serial_no(e,t,a){var r=this,s=frappe.get_doc(t,a);s&&s.doctype==="Purchase Receipt Item Supplied"||s&&s.serial_no&&(s.item_code?(s.serial_no=s.serial_no.replace(/,/g,`
`),s.conversion_factor=s.conversion_factor||1,refresh_field("serial_no",s.name,s.parentfield),!e.is_return&&cint(frappe.user_defaults.set_qty_in_transactions_based_on_serial_no_input)&&setTimeout(()=>{r.update_qty(t,a)},1e4)):this.frm.trigger("item_code",t,a))}update_qty(e,t){var a=[],r=[],s=frappe.get_doc(e,t);r=s.serial_no.split(`
`);for(var n=0;n<r.length;n++)r[n]!=""&&a.push(r[n]);frappe.model.set_value(s.doctype,s.name,"qty",a.length/s.conversion_factor),frappe.model.set_value(s.doctype,s.name,"stock_qty",a.length)}validate(){this.calculate_taxes_and_totals(!1)}update_stock(){this.frm.trigger("set_default_internal_warehouse")}set_default_internal_warehouse(){let e=this;(this.frm.doc.doctype==="Sales Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Delivery Note")&&this.frm.doc.is_internal_customer&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(t){e.frm.set_value("set_target_warehouse",t.default_in_transit_warehouse)}),(this.frm.doc.doctype==="Purchase Invoice"&&e.frm.doc.update_stock||this.frm.doc.doctype=="Purchase Receipt")&&this.frm.doc.is_internal_supplier&&this.frm.doc.company===this.frm.doc.represents_company&&frappe.db.get_value("Company",this.frm.doc.company,"default_in_transit_warehouse",function(t){e.frm.set_value("set_from_warehouse",t.default_in_transit_warehouse)})}company(){var e=this,t=function(){if(e.frm.doc.company&&e.frm.fields_dict.currency){var r=e.get_company_currency(),s=frappe.get_doc(":Company",e.frm.doc.company);e.frm.doc.currency||e.frm.set_value("currency",r),e.frm.doc.currency==r&&e.frm.set_value("conversion_rate",1),e.frm.doc.price_list_currency==r&&e.frm.set_value("plc_conversion_rate",1),s.default_letter_head&&e.frm.fields_dict.letter_head&&e.frm.set_value("letter_head",s.default_letter_head);let n=["Sales Invoice","Quotation","Sales Order","Delivery Note"];s.default_selling_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&n.indexOf(e.frm.doc.doctype)!=-1&&e.frm.set_value("tc_name",s.default_selling_terms);let l=["Request for Quotation","Supplier Quotation","Purchase Order","Material Request","Purchase Receipt"];s.default_buying_terms&&frappe.meta.has_field(e.frm.doc.doctype,"tc_name")&&l.indexOf(e.frm.doc.doctype)!=-1&&e.frm.set_value("tc_name",s.default_buying_terms),frappe.run_serially([()=>e.frm.script_manager.trigger("currency"),()=>e.update_item_tax_map(),()=>e.apply_default_taxes(),()=>e.apply_pricing_rule()])}},a=function(r){if(in_list(["Sales Invoice","Purchase Invoice"],e.frm.doc.doctype)){if(e.frm.doc.doctype=="Sales Invoice")var s="Customer",n="debit_to";else var s="Supplier",n="credit_to";var l=e.frm.doc[frappe.model.scrub(s)];if(l&&e.frm.doc.company)return frappe.call({method:"erpnext.accounts.party.get_party_account",args:{company:e.frm.doc.company,party_type:s,party:l},callback:function(c){!c.exc&&c.message&&(e.frm.set_value(n,c.message),r())}});r()}else r()};frappe.meta.get_docfield(this.frm.doctype,"shipping_address")&&in_list(["Purchase Order","Purchase Receipt","Purchase Invoice"],this.frm.doctype)?(erpnext.utils.get_shipping_address(this.frm,function(){a(t)}),this.frm.doc.company&&frappe.meta.get_docfield(this.frm.doctype,"billing_address")&&frappe.call({method:"erpnext.setup.doctype.company.company.get_default_company_address",args:{name:this.frm.doc.company,existing_address:this.frm.doc.billing_address||""},debounce:2e3,callback:function(r){r.message?e.frm.set_value("billing_address",r.message):frappe.meta.get_docfield(e.frm.doctype,"company_address")&&e.frm.set_value("company_address","")}})):a(t),this.frm.doc.company&&(erpnext.last_selected_company=this.frm.doc.company)}transaction_date(){this.frm.doc.transaction_date&&(this.frm.transaction_date=this.frm.doc.transaction_date,frappe.ui.form.trigger(this.frm.doc.doctype,"currency"))}posting_date(){var e=this;if(this.frm.doc.posting_date){if(this.frm.posting_date=this.frm.doc.posting_date,this.frm.doc.doctype=="Sales Invoice"&&this.frm.doc.customer||this.frm.doc.doctype=="Purchase Invoice"&&this.frm.doc.supplier)return frappe.call({method:"erpnext.accounts.party.get_due_date",args:{posting_date:e.frm.doc.posting_date,party_type:e.frm.doc.doctype=="Sales Invoice"?"Customer":"Supplier",bill_date:e.frm.doc.bill_date,party:e.frm.doc.doctype=="Sales Invoice"?e.frm.doc.customer:e.frm.doc.supplier,company:e.frm.doc.company},callback:function(t,a){t.message&&(e.frm.doc.due_date=t.message,refresh_field("due_date"),frappe.ui.form.trigger(e.frm.doc.doctype,"currency"),e.recalculate_terms())}});frappe.ui.form.trigger(e.frm.doc.doctype,"currency")}}due_date(){if(this.frm.doc.due_date&&!this.frm.updating_party_details&&!this.frm.doc.is_pos&&(this.frm.doc.payment_terms_template||this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length)){var e="",t="",a=__("Please clear the")+" ";this.frm.doc.payment_terms_template&&(e=__("selected Payment Terms Template"),a=a+e),(this.frm.doc.payment_schedule||[]).length&&(t=__("Payment Schedule Table"),e.length!==0&&(t=" and "+t),a=a+t),frappe.msgprint(a)}}bill_date(){this.posting_date()}recalculate_terms(){let e=this.frm.doc;if(e.payment_terms_template)this.payment_terms_template();else if(e.payment_schedule){let t=this;e.payment_schedule.forEach(function(a){a.payment_term?t.payment_term(e,a.doctype,a.name):frappe.model.set_value(a.doctype,a.name,"due_date",e.posting_date||e.transaction_date)})}}get_company_currency(){return erpnext.get_currency(this.frm.doc.company)}contact_person(){erpnext.utils.get_contact_details(this.frm)}currency(){var e=this.frm.doc.transaction_date||this.frm.doc.posting_date,t=this;this.set_dynamic_labels();var a=this.get_company_currency();this.frm.doc.currency&&this.frm.doc.currency!==a&&!this.frm.doc.ignore_pricing_rule?this.get_exchange_rate(e,this.frm.doc.currency,a,function(r){r!=t.frm.doc.conversion_rate&&(t.set_margin_amount_based_on_currency(r),t.set_actual_charges_based_on_currency(r),t.frm.set_value("conversion_rate",r))}):this.conversion_rate()}conversion_rate(){let e=this.frm;this.frm.doc.currency===this.get_company_currency()&&this.frm.set_value("conversion_rate",1),this.frm.doc.currency===this.frm.doc.price_list_currency&&this.frm.doc.plc_conversion_rate!==this.frm.doc.conversion_rate&&this.frm.set_value("plc_conversion_rate",this.frm.doc.conversion_rate),flt(this.frm.doc.conversion_rate)>0&&(this.frm.doc.ignore_pricing_rule?this.calculate_taxes_and_totals():this.in_apply_price_list||this.apply_price_list()),this.frm.set_df_property("conversion_rate","read_only",erpnext.stale_rate_allowed()?0:1)}shipping_rule(){var e=this;if(this.frm.doc.shipping_rule)return this.frm.call({doc:this.frm.doc,method:"apply_shipping_rule"}).fail(()=>this.frm.set_value("shipping_rule",""))}set_margin_amount_based_on_currency(e){if(in_list(["Quotation","Sales Order","Delivery Note","Sales Invoice","Purchase Invoice","Purchase Order","Purchase Receipt"]),this.frm.doc.doctype){var t=this;$.each(this.frm.doc.items||[],function(a,r){r.margin_type=="Amount"&&frappe.model.set_value(r.doctype,r.name,"margin_rate_or_amount",flt(r.margin_rate_or_amount)/flt(e))})}}set_actual_charges_based_on_currency(e){var t=this;$.each(this.frm.doc.taxes||[],function(a,r){r.charge_type=="Actual"&&frappe.model.set_value(r.doctype,r.name,"tax_amount",flt(r.base_tax_amount)/flt(e))})}get_exchange_rate(e,t,a,r){var s;if(["Quotation","Sales Order","Delivery Note","Sales Invoice"].includes(this.frm.doctype)?s="for_selling":["Purchase Order","Purchase Receipt","Purchase Invoice"].includes(this.frm.doctype)&&(s="for_buying"),!(!e||!t||!a))return frappe.call({method:"erpnext.setup.utils.get_exchange_rate",args:{transaction_date:e,from_currency:t,to_currency:a,args:s},freeze:!0,freeze_message:__("Fetching exchange rates ..."),callback:function(n){r(flt(n.message))}})}price_list_currency(){var e=this;this.set_dynamic_labels();var t=this.get_company_currency();this.frm.doc.price_list_currency!==t&&!this.frm.doc.ignore_pricing_rule?this.get_exchange_rate(this.frm.doc.posting_date,this.frm.doc.price_list_currency,t,function(a){e.frm.set_value("plc_conversion_rate",a)}):this.plc_conversion_rate()}plc_conversion_rate(){this.frm.doc.price_list_currency===this.get_company_currency()?this.frm.set_value("plc_conversion_rate",1):this.frm.doc.price_list_currency===this.frm.doc.currency&&this.frm.doc.plc_conversion_rate&&cint(this.frm.doc.plc_conversion_rate)!=1&&cint(this.frm.doc.plc_conversion_rate)!=cint(this.frm.doc.conversion_rate)&&this.frm.set_value("conversion_rate",this.frm.doc.plc_conversion_rate),this.in_apply_price_list||this.apply_price_list(null,!0)}uom(e,t,a){var r=this,s=frappe.get_doc(t,a);if(s.item_code&&s.uom)return this.frm.call({method:"erpnext.stock.get_item_details.get_conversion_factor",args:{item_code:s.item_code,uom:s.uom},callback:function(n){n.exc||frappe.model.set_value(t,a,"conversion_factor",n.message.conversion_factor)}});r.calculate_stock_uom_rate(e,t,a)}conversion_factor(e,t,a,r){if(frappe.meta.get_docfield(t,"stock_qty",a)){var s=frappe.get_doc(t,a);if(frappe.model.round_floats_in(s,["qty","conversion_factor"]),s.stock_qty=flt(s.qty*s.conversion_factor,precision("stock_qty",s)),refresh_field("stock_qty",s.name,s.parentfield),this.toggle_conversion_factor(s),e.doctype!="Material Request"&&(s.total_weight=flt(s.stock_qty*s.weight_per_unit),refresh_field("total_weight",s.name,s.parentfield),this.calculate_net_weight()),frappe.flags.dont_fetch_price_list_rate)return;!r&&frappe.meta.has_field(e.doctype,"price_list_currency")&&this.apply_price_list(s,!0),this.calculate_stock_uom_rate(e,t,a)}}batch_no(e,t,a){let r=frappe.get_doc(t,a);this.apply_price_list(r,!0)}toggle_conversion_factor(e){this.frm.get_field("items").grid.fields_map.conversion_factor&&this.frm.fields_dict.items.grid.toggle_enable("conversion_factor",e.uom!=e.stock_uom&&!frappe.meta.get_docfield(cur_frm.fields_dict.items.grid.doctype,"conversion_factor").read_only)}qty(e,t,a){let r=frappe.get_doc(t,a);this.conversion_factor(e,t,a,!0),this.calculate_stock_uom_rate(e,t,a),this.apply_pricing_rule(r,!0)}calculate_stock_uom_rate(e,t,a){let r=frappe.get_doc(t,a);r.stock_uom_rate=flt(r.rate)/flt(r.conversion_factor),refresh_field("stock_uom_rate",r.name,r.parentfield)}service_stop_date(e,t,a){var r=locals[t][a];if(r.service_stop_date){let s=Date.parse(r.service_start_date),n=Date.parse(r.service_end_date),l=Date.parse(r.service_stop_date);l<s?(frappe.model.set_value(t,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be before Service Start Date"))):l>n&&(frappe.model.set_value(t,a,"service_stop_date",""),frappe.throw(__("Service Stop Date cannot be after Service End Date")))}}service_start_date(e,t,a){var r=locals[t][a];r.service_start_date&&frappe.call({method:"erpnext.stock.get_item_details.calculate_service_end_date",args:{args:r},callback:function(s){frappe.model.set_value(t,a,"service_end_date",s.message.service_end_date)}})}calculate_net_weight(){var e=this;this.frm.doc.total_net_weight=0,$.each(this.frm.doc.items||[],function(t,a){e.frm.doc.total_net_weight+=flt(a.total_weight)}),refresh_field("total_net_weight"),this.shipping_rule()}set_dynamic_labels(){this.frm.toggle_reqd("plc_conversion_rate",!!(this.frm.doc.price_list_name&&this.frm.doc.price_list_currency));var e=this.get_company_currency();this.change_form_labels(e),this.change_grid_labels(e),this.frm.refresh_fields()}change_form_labels(e){var t=this;this.frm.set_currency_labels(["base_total","base_net_total","base_total_taxes_and_charges","base_discount_amount","base_grand_total","base_rounded_total","base_in_words","base_taxes_and_charges_added","base_taxes_and_charges_deducted","total_amount_to_pay","base_paid_amount","base_write_off_amount","base_change_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],e),this.frm.set_currency_labels(["total","net_total","total_taxes_and_charges","discount_amount","grand_total","taxes_and_charges_added","taxes_and_charges_deducted","rounded_total","in_words","paid_amount","write_off_amount","operating_cost","scrap_material_cost","rounding_adjustment","raw_material_cost","total_cost"],this.frm.doc.currency),this.frm.set_currency_labels(["outstanding_amount","total_advance"],this.frm.doc.party_account_currency),cur_frm.set_df_property("conversion_rate","description","1 "+this.frm.doc.currency+" = [?] "+e),this.frm.doc.price_list_currency&&this.frm.doc.price_list_currency!=e&&cur_frm.set_df_property("plc_conversion_rate","description","1 "+this.frm.doc.price_list_currency+" = [?] "+e),this.frm.toggle_display(["conversion_rate","base_total","base_net_total","base_total_taxes_and_charges","base_taxes_and_charges_added","base_taxes_and_charges_deducted","base_grand_total","base_rounded_total","base_in_words","base_discount_amount","base_paid_amount","base_write_off_amount","base_operating_cost","base_raw_material_cost","base_total_cost","base_scrap_material_cost","base_rounding_adjustment"],this.frm.doc.currency!=e),this.frm.toggle_display(["plc_conversion_rate","price_list_currency"],this.frm.doc.price_list_currency!=e);var a=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(r){return r.included_in_print_rate===1}).length;frappe.meta.get_docfield(cur_frm.doctype,"net_total")&&cur_frm.toggle_display("net_total",a),frappe.meta.get_docfield(cur_frm.doctype,"base_net_total")&&cur_frm.toggle_display("base_net_total",a&&t.frm.doc.currency!=e)}change_grid_labels(e){var t=this;if(this.update_item_grid_labels(e),this.toggle_item_grid_columns(e),this.frm.doc.operations&&this.frm.doc.operations.length>0){this.frm.set_currency_labels(["operating_cost","hour_rate"],this.frm.doc.currency,"operations"),this.frm.set_currency_labels(["base_operating_cost","base_hour_rate"],e,"operations");var a=this.frm.fields_dict.operations.grid;$.each(["base_operating_cost","base_hour_rate"],function(r,s){frappe.meta.get_docfield(a.doctype,s)&&a.set_column_disp(s,t.frm.doc.currency!=e)})}if(this.frm.doc.scrap_items&&this.frm.doc.scrap_items.length>0){this.frm.set_currency_labels(["rate","amount"],this.frm.doc.currency,"scrap_items"),this.frm.set_currency_labels(["base_rate","base_amount"],e,"scrap_items");var a=this.frm.fields_dict.scrap_items.grid;$.each(["base_rate","base_amount"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,t.frm.doc.currency!=e)})}this.frm.doc.taxes&&this.frm.doc.taxes.length>0&&(this.frm.set_currency_labels(["tax_amount","total","tax_amount_after_discount"],this.frm.doc.currency,"taxes"),this.frm.set_currency_labels(["base_tax_amount","base_total","base_tax_amount_after_discount"],e,"taxes")),this.frm.doc.advances&&this.frm.doc.advances.length>0&&this.frm.set_currency_labels(["advance_amount","allocated_amount"],this.frm.doc.party_account_currency,"advances"),this.update_payment_schedule_grid_labels(e)}update_item_grid_labels(e){this.frm.set_currency_labels(["base_rate","base_net_rate","base_price_list_rate","base_amount","base_net_amount","base_rate_with_margin"],e,"items"),this.frm.set_currency_labels(["rate","net_rate","price_list_rate","amount","net_amount","stock_uom_rate","rate_with_margin"],this.frm.doc.currency,"items")}update_payment_schedule_grid_labels(e){let t=this;if(this.frm.doc.payment_schedule&&this.frm.doc.payment_schedule.length>0){this.frm.set_currency_labels(["base_payment_amount","base_outstanding","base_paid_amount"],e,"payment_schedule"),this.frm.set_currency_labels(["payment_amount","outstanding","paid_amount"],this.frm.doc.currency,"payment_schedule");var a=this.frm.fields_dict.payment_schedule.grid;$.each(["base_payment_amount","base_outstanding","base_paid_amount"],function(r,s){frappe.meta.get_docfield(a.doctype,s)&&a.set_column_disp(s,t.frm.doc.currency!=e)})}}toggle_item_grid_columns(e){let t=this;var a=this.frm.fields_dict.items.grid;$.each(["base_rate","base_price_list_rate","base_amount","base_rate_with_margin"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,t.frm.doc.currency!=e)});var r=cint(cur_frm.doc.discount_amount)||(cur_frm.doc.taxes||[]).filter(function(s){return s.included_in_print_rate===1}).length;$.each(["net_rate","net_amount"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,r)}),$.each(["base_net_rate","base_net_amount"],function(s,n){frappe.meta.get_docfield(a.doctype,n)&&a.set_column_disp(n,r&&t.frm.doc.currency!=e)})}recalculate(){this.calculate_taxes_and_totals()}recalculate_values(){this.calculate_taxes_and_totals()}calculate_charges(){this.calculate_taxes_and_totals()}ignore_pricing_rule(){if(this.frm.doc.ignore_pricing_rule){var e=this,t=[];return $.each(this.frm.doc.items||[],function(a,r){r.item_code&&!r.is_free_item&&t.push({doctype:r.doctype,name:r.name,item_code:r.item_code,pricing_rules:r.pricing_rules,parenttype:r.parenttype,parent:r.parent,price_list_rate:r.price_list_rate})}),this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.remove_pricing_rules",args:{item_list:t},callback:function(a){!a.exc&&a.message&&(a.message.forEach(r=>{e.remove_pricing_rule(r)}),e._set_values_for_item_list(a.message),e.calculate_taxes_and_totals(),e.frm.doc.apply_discount_on&&e.frm.trigger("apply_discount_on"))}})}else this.apply_pricing_rule()}apply_pricing_rule(e,t){var a=this,r=this._get_args(e);if(!(r.items&&r.items.length)){t&&a.calculate_taxes_and_totals();return}return this.frm.call({method:"erpnext.accounts.doctype.pricing_rule.pricing_rule.apply_pricing_rule",args:{args:r,doc:a.frm.doc},callback:function(s){!s.exc&&s.message&&(a._set_values_for_item_list(s.message),e&&a.set_gross_profit(e),a.frm.doc.apply_discount_on&&a.frm.trigger("apply_discount_on"))}})}_get_args(e){var t=this;return{items:this._get_item_list(e),customer:t.frm.doc.customer||t.frm.doc.party_name,quotation_to:t.frm.doc.quotation_to,customer_group:t.frm.doc.customer_group,territory:t.frm.doc.territory,supplier:t.frm.doc.supplier,supplier_group:t.frm.doc.supplier_group,currency:t.frm.doc.currency,conversion_rate:t.frm.doc.conversion_rate,price_list:t.frm.doc.selling_price_list||t.frm.doc.buying_price_list,price_list_currency:t.frm.doc.price_list_currency,plc_conversion_rate:t.frm.doc.plc_conversion_rate,company:t.frm.doc.company,transaction_date:t.frm.doc.transaction_date||t.frm.doc.posting_date,campaign:t.frm.doc.campaign,sales_partner:t.frm.doc.sales_partner,ignore_pricing_rule:t.frm.doc.ignore_pricing_rule,doctype:t.frm.doc.doctype,name:t.frm.doc.name,is_return:cint(t.frm.doc.is_return),update_stock:in_list(["Sales Invoice","Purchase Invoice"],t.frm.doc.doctype)?cint(t.frm.doc.update_stock):0,conversion_factor:t.frm.doc.conversion_factor,pos_profile:t.frm.doc.doctype=="Sales Invoice"?t.frm.doc.pos_profile:"",coupon_code:t.frm.doc.coupon_code}}_get_item_list(e){var t=[],a=function(r){r.item_code&&(t.push({doctype:r.doctype,name:r.name,child_docname:r.name,item_code:r.item_code,item_group:r.item_group,brand:r.brand,qty:r.qty,stock_qty:r.stock_qty,uom:r.uom,stock_uom:r.stock_uom,parenttype:r.parenttype,parent:r.parent,pricing_rules:r.pricing_rules,warehouse:r.warehouse,serial_no:r.serial_no,batch_no:r.batch_no,price_list_rate:r.price_list_rate,conversion_factor:r.conversion_factor||1}),in_list(["Quotation Item","Sales Order Item","Delivery Note Item","Sales Invoice Item","Purchase Invoice Item","Purchase Order Item","Purchase Receipt Item"]),r.doctype&&(t[0].margin_type=r.margin_type,t[0].margin_rate_or_amount=r.margin_rate_or_amount))};return e?a(e):$.each(this.frm.doc.items||[],function(r,s){a(s)}),t}_set_values_for_item_list(e){for(var t=this,a={},r=0,s=e.length;r<s;r++){var n=e[r];let d=frappe.get_doc(n.doctype,n.name);var l=frappe.model.get_value(n.doctype,n.name,"pricing_rules");for(var c in n){var _=n[c];["doctype","name"].indexOf(c)===-1&&(c=="price_list_rate"&&(d.rate=_),c!=="free_item_data"&&(d[c]=_))}frappe.model.round_floats_in(d,["price_list_rate","discount_percentage"]),!t.frm.doc.ignore_pricing_rule&&l&&!n.pricing_rules?t.apply_price_list(frappe.get_doc(n.doctype,n.name)):n.pricing_rules||t.remove_pricing_rule(frappe.get_doc(n.doctype,n.name)),n.free_item_data&&t.apply_product_discount(n),n.apply_rule_on_other_items&&(a[n.name]=n)}t.frm.refresh_field("items"),t.apply_rule_on_other_items(a),t.calculate_taxes_and_totals()}apply_rule_on_other_items(e){let t=this,a=["discount_percentage","pricing_rules","discount_amount","rate"];for(var r in e){let s=e[r];s&&s.apply_rule_on_other_items&&t.frm.doc.items.forEach(n=>{if(in_list(s.apply_rule_on_other_items,n[s.apply_rule_on]))for(var l in s)in_list(a,l)&&s[l]&&(s.price_or_product_discount==="price"||l==="pricing_rules")&&frappe.model.set_value(n.doctype,n.name,l,s[l])})}}apply_product_discount(e){let t=this.frm.doc.items.filter(r=>r.is_free_item)||[],a=t.map(r=>(r.item_code,r.pricing_rules));e.free_item_data.forEach(r=>{let s={};!t||!in_list(a,(r.item_code,r.pricing_rules))?s=frappe.model.add_child(this.frm.doc,this.frm.doc.doctype+" Item","items"):t&&(s=t.filter(n=>n.item_code===r.item_code&&n.pricing_rules===r.pricing_rules)[0]);for(let n in r)s[n]=r[n]}),e.free_item_data="",refresh_field("items")}apply_price_list(e,t){t||this.frm.set_value("plc_conversion_rate","");var a=this,r=this._get_args(e);if(!!(r.items&&r.items.length||r.price_list)&&a.in_apply_price_list!=!0)return a.in_apply_price_list=!0,this.frm.call({method:"erpnext.stock.get_item_details.apply_price_list",args:{args:r},callback:function(s){s.exc?a.in_apply_price_list=!1:frappe.run_serially([()=>a.frm.set_value("price_list_currency",s.message.parent.price_list_currency),()=>a.frm.set_value("plc_conversion_rate",s.message.parent.plc_conversion_rate),()=>{r.items.length&&a._set_values_for_item_list(s.message.children)},()=>{a.in_apply_price_list=!1}])}}).always(()=>{a.in_apply_price_list=!1})}remove_pricing_rule(e){let t=this,a=["discount_percentage","discount_amount","margin_rate_or_amount","rate_with_margin"];if(e.remove_free_item){var r=[];t.frm.doc.items.forEach(s=>{(s.item_code!=e.remove_free_item||!s.is_free_item)&&r.push(s)}),t.frm.doc.items=r,refresh_field("items")}else if(e.applied_on_items&&e.apply_on){let s=e.applied_on_items.split(",");t.frm.doc.items.forEach(n=>{s.includes(n[e.apply_on])&&(a.forEach(l=>{n[l]=0}),["pricing_rules","margin_type"].forEach(l=>{n[l]&&(n[l]="")}))}),t.trigger_price_list_rate()}}trigger_price_list_rate(){var e=this;this.frm.doc.items.forEach(t=>{e.frm.script_manager.trigger("price_list_rate",t.doctype,t.name)})}validate_company_and_party(){var e=this,t=!0;return $.each(["company","customer"],function(a,r){frappe.meta.has_field(e.frm.doc.doctype,r)&&e.frm.doc.doctype!="Purchase Order"&&(e.frm.doc[r]||(frappe.msgprint(__("Please specify")+": "+frappe.meta.get_label(e.frm.doc.doctype,r,e.frm.doc.name)+". "+__("It is needed to fetch Item Details.")),t=!1))}),t}get_terms(){var e=this;erpnext.utils.get_terms(this.frm.doc.tc_name,this.frm.doc,function(t){t.exc||e.frm.set_value("terms",t.message)})}taxes_and_charges(){var e=this;if(this.frm.doc.taxes_and_charges)return this.frm.call({method:"erpnext.controllers.accounts_controller.get_taxes_and_charges",args:{master_doctype:frappe.meta.get_docfield(this.frm.doc.doctype,"taxes_and_charges",this.frm.doc.name).options,master_name:this.frm.doc.taxes_and_charges},callback:function(t){if(!t.exc)if(e.frm.doc.shipping_rule&&e.frm.doc.taxes){for(let a of t.message)e.frm.add_child("taxes",a);refresh_field("taxes")}else e.frm.set_value("taxes",t.message),e.calculate_taxes_and_totals()}})}tax_category(){var e=this;e.frm.updating_party_details||frappe.run_serially([()=>this.update_item_tax_map(),()=>erpnext.utils.set_taxes(this.frm,"tax_category")])}update_item_tax_map(){let e=this,t=[],a={},r={};if($.each(this.frm.doc.items||[],function(s,n){n.item_code&&(t.push([n.item_code,n.name]),a[n.name]=n.net_rate,r[n.name]=n.item_tax_template)}),t.length)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_info",args:{company:e.frm.doc.company,tax_category:cstr(e.frm.doc.tax_category),item_codes:t,item_rates:a,item_tax_templates:r},callback:function(s){s.exc||$.each(e.frm.doc.items||[],function(n,l){l.name&&s.message.hasOwnProperty(l.name)&&s.message[l.name].item_tax_template&&(l.item_tax_template=s.message[l.name].item_tax_template,l.item_tax_rate=s.message[l.name].item_tax_rate,e.add_taxes_from_item_tax_template(l.item_tax_rate))})}})}item_tax_template(e,t,a){var r=this;if(!r.frm.updating_party_details){var s=frappe.get_doc(t,a);if(s.item_tax_template)return this.frm.call({method:"erpnext.stock.get_item_details.get_item_tax_map",args:{company:r.frm.doc.company,item_tax_template:s.item_tax_template,as_json:!0},callback:function(n){n.exc||(s.item_tax_rate=n.message,r.calculate_taxes_and_totals())}});s.item_tax_rate="{}",r.calculate_taxes_and_totals()}}is_recurring(){if(this.frm.doc.is_recurring&&this.frm.doc.__islocal){frappe.msgprint(__("Please set recurring after saving")),this.frm.set_value("is_recurring",0);return}if(this.frm.doc.is_recurring){this.frm.doc.recurring_id||this.frm.set_value("recurring_id",this.frm.doc.name);var e=this.frm.doc.owner=="Administrator"?frappe.user_info("Administrator").email:this.frm.doc.owner;this.frm.doc.notification_email_address=$.map([cstr(e),cstr(this.frm.doc.contact_email)],function(t){return t||null}).join(", "),this.frm.doc.repeat_on_day_of_month=frappe.datetime.str_to_obj(this.frm.doc.posting_date).getDate()}refresh_many(["notification_email_address","repeat_on_day_of_month"])}from_date(){if(this.frm.doc.from_date){var e={Monthly:1,Quarterly:3,"Half-yearly":6,Yearly:12},t=e[this.frm.doc.recurring_type];if(t){var a=frappe.datetime.add_months(this.frm.doc.from_date,t);this.frm.doc.to_date=frappe.datetime.add_days(a,-1),refresh_field("to_date")}}}set_gross_profit(e){if(["Sales Order","Quotation"].includes(this.frm.doc.doctype)&&e.valuation_rate){var t=flt(e.rate)*flt(this.frm.doc.conversion_rate||1);e.gross_profit=flt((t-e.valuation_rate)*e.stock_qty,precision("amount",e))}}setup_item_selector(){}get_advances(){if(!this.frm.is_return)return this.frm.call({method:"set_advances",doc:this.frm.doc,callback:function(e,t){refresh_field("advances")}})}make_payment_entry(){return frappe.call({method:cur_frm.cscript.get_method_for_payment(),args:{dt:cur_frm.doc.doctype,dn:cur_frm.doc.name},callback:function(e){var t=frappe.model.sync(e.message);frappe.set_route("Form",t[0].doctype,t[0].name)}})}make_quality_inspection(){let e=[],t=[{label:"Items",fieldtype:"Table",fieldname:"items",cannot_add_rows:!0,in_place_edit:!0,data:e,get_data:()=>e,fields:[{fieldtype:"Data",fieldname:"docname",hidden:!0},{fieldtype:"Read Only",fieldname:"item_code",label:__("Item Code"),in_list_view:!0},{fieldtype:"Read Only",fieldname:"item_name",label:__("Item Name"),in_list_view:!0},{fieldtype:"Float",fieldname:"qty",label:__("Accepted Quantity"),in_list_view:!0,read_only:!0},{fieldtype:"Float",fieldname:"sample_size",label:__("Sample Size"),reqd:!0,in_list_view:!0},{fieldtype:"Data",fieldname:"description",label:__("Description"),hidden:!0},{fieldtype:"Data",fieldname:"serial_no",label:__("Serial No"),hidden:!0},{fieldtype:"Data",fieldname:"batch_no",label:__("Batch No"),hidden:!0}]}],a=this,r=new frappe.ui.Dialog({title:__("Select Items for Quality Inspection"),fields:t,primary_action:function(){let s=r.get_values();frappe.call({method:"erpnext.controllers.stock_controller.make_quality_inspections",args:{doctype:a.frm.doc.doctype,docname:a.frm.doc.name,items:s.items},freeze:!0,callback:function(n){n.message.length>0&&(n.message.length===1?frappe.set_route("Form","Quality Inspection",n.message[0]):(frappe.route_options={reference_type:a.frm.doc.doctype,reference_name:a.frm.doc.name},frappe.set_route("List","Quality Inspection"))),r.hide()}})},primary_action_label:__("Create")});this.frm.doc.items.forEach(s=>{if(!s.quality_inspection){let n=r.fields_dict.items;n.df.data.push({docname:s.name,item_code:s.item_code,item_name:s.item_name,qty:s.qty,description:s.description,serial_no:s.serial_no,batch_no:s.batch_no}),n.grid.refresh()}}),e=r.fields_dict.items.df.data,e.length?r.show():frappe.msgprint(__("All items in this document already have a linked Quality Inspection."))}get_method_for_payment(){var e="erpnext.accounts.doctype.payment_entry.payment_entry.get_payment_entry";return cur_frm.doc.__onload&&cur_frm.doc.__onload.make_payment_via_journal_entry&&(in_list(["Sales Invoice","Purchase Invoice"],cur_frm.doc.doctype)?e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_invoice":e="erpnext.accounts.doctype.journal_entry.journal_entry.get_payment_entry_against_order"),e}set_query_for_batch(e,t,a){var r=this,s=frappe.get_doc(t,a);if(!s.item_code)frappe.throw(__("Please enter Item Code to get batch no"));else{if(e.doctype=="Purchase Receipt"||e.doctype=="Purchase Invoice"&&e.update_stock)return{filters:{item:s.item_code}};{let n={item_code:s.item_code,posting_date:r.frm.doc.posting_date||frappe.datetime.nowdate()};return e.is_return&&(n.is_return=1),s.warehouse&&(n.warehouse=s.warehouse),{query:"erpnext.controllers.queries.get_batch_no",filters:n}}}}set_query_for_item_tax_template(e,t,a){var r=frappe.get_doc(t,a);if(r.item_code){let s={item_code:r.item_code,valid_from:["<=",e.transaction_date||e.bill_date||e.posting_date],item_group:r.item_group};return e.tax_category&&(s.tax_category=e.tax_category),e.company&&(s.company=e.company),{query:"erpnext.controllers.queries.get_tax_template",filters:s}}else return e.company?{filters:{company:e.company}}:{}}payment_terms_template(){var e=this;let t=this.frm.doc;if(t.payment_terms_template&&t.doctype!=="Delivery Note"){var a=t.posting_date||t.transaction_date;frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_terms",args:{terms_template:t.payment_terms_template,posting_date:a,grand_total:t.rounded_total||t.grand_total,base_grand_total:t.base_rounded_total||t.base_grand_total,bill_date:t.bill_date},callback:function(r){if(r.message&&!r.exc){e.frm.set_value("payment_schedule",r.message);let s=e.get_company_currency();e.update_payment_schedule_grid_labels(s)}}})}}payment_term(e,t,a){let r=this;var s=locals[t][a];s.payment_term&&frappe.call({method:"erpnext.controllers.accounts_controller.get_payment_term_details",args:{term:s.payment_term,bill_date:this.frm.doc.bill_date,posting_date:this.frm.doc.posting_date||this.frm.doc.transaction_date,grand_total:this.frm.doc.rounded_total||this.frm.doc.grand_total,base_grand_total:this.frm.doc.base_rounded_total||this.frm.doc.base_grand_total},callback:function(n){if(n.message&&!n.exc)for(var l in n.message){frappe.model.set_value(t,a,l,n.message[l]);let c=r.get_company_currency();r.update_payment_schedule_grid_labels(c)}}})}against_blanket_order(e,t,a){var r=locals[t][a];r.against_blanket_order||(frappe.model.set_value(this.frm.doctype+" Item",r.name,"blanket_order",null),frappe.model.set_value(this.frm.doctype+" Item",r.name,"blanket_order_rate",0))}blanket_order(e,t,a){var r=this,s=locals[t][a];s.blanket_order&&(s.parenttype=="Sales Order"||s.parenttype=="Purchase Order")&&frappe.call({method:"erpnext.stock.get_item_details.get_blanket_order_details",args:{args:{item_code:s.item_code,customer:e.customer,supplier:e.supplier,company:e.company,transaction_date:e.transaction_date,blanket_order:s.blanket_order}},callback:function(n){n.message?frappe.run_serially([()=>frappe.model.set_value(t,a,"blanket_order_rate",n.message.blanket_order_rate),()=>r.frm.script_manager.trigger("price_list_rate",t,a)]):frappe.throw(__("Invalid Blanket Order for the selected Customer and Item"))}})}set_reserve_warehouse(){this.autofill_warehouse(this.frm.doc.supplied_items,"reserve_warehouse",this.frm.doc.set_reserve_warehouse)}set_warehouse(){this.autofill_warehouse(this.frm.doc.items,"warehouse",this.frm.doc.set_warehouse)}set_target_warehouse(){this.autofill_warehouse(this.frm.doc.items,"target_warehouse",this.frm.doc.set_target_warehouse)}set_from_warehouse(){this.autofill_warehouse(this.frm.doc.items,"from_warehouse",this.frm.doc.set_from_warehouse)}autofill_warehouse(e,t,a){if(a&&e&&e.length){let r=e[0].doctype;$.each(e||[],function(s,n){frappe.model.set_value(r,n.name,t,a)})}}coupon_code(){var e=this;this.frm.doc.coupon_code?frappe.run_serially([()=>this.frm.doc.ignore_pricing_rule=1,()=>e.ignore_pricing_rule(),()=>this.frm.doc.ignore_pricing_rule=0,()=>e.apply_pricing_rule(),()=>this.frm.save()]):frappe.run_serially([()=>this.frm.doc.ignore_pricing_rule=1,()=>e.ignore_pricing_rule()])}};erpnext.show_serial_batch_selector=function(i,e,t,a,r){let s,n,l;i.doc.is_return?["Purchase Receipt","Purchase Invoice"].includes(i.doc.doctype)?(l=!0,s=e.warehouse):["Delivery Note","Sales Invoice"].includes(i.doc.doctype)&&(n=!0):i.doc.doctype=="Stock Entry"?i.doc.purpose=="Material Receipt"?n=!0:(l=!0,s=e.s_warehouse):(l=!0,s=e.warehouse),s||(n?s=["like",""]:l&&(s=["!=",""])),frappe.require("assets/erpnext/js/utils/serial_no_batch_selector.js",function(){new erpnext.SerialNoBatchSelector({frm:i,item:e,warehouse_details:{type:"Warehouse",name:s},callback:t,on_close:a},r)})};erpnext.apply_putaway_rule=(i,e=null)=>{i.doc.company||frappe.throw({message:__("Please select a Company first."),title:__("Mandatory")}),i.doc.items.length&&frappe.call({method:"erpnext.stock.doctype.putaway_rule.putaway_rule.apply_putaway_rule",args:{doctype:i.doctype,items:i.doc.items,company:i.doc.company,sync:!0,purpose:e},callback:t=>{!t.exc&&t.message&&(i.clear_table("items"),t.message.forEach(r=>{delete r.name;let s=i.add_child("items");Object.assign(s,r),i.script_manager.trigger("qty",s.doctype,s.name)}),i.get_field("items").grid.refresh())}})};frappe.templates.item_selector=`<div class="app-listing item-list image-view-container item-selector">
{% for (var i=0; i < data.length; i++) { var item = data[i]; %}
	{% if (i % 4 === 0) { %}<div class="image-view-row">{% } %}
	<div class="image-view-item" data-name="{{ item.name }}">
		<div class="image-view-header doclist-row">
			<div class="list-value">
				<a class="grey list-id" data-name="{{item.name}}"
					title="{{ item.item_name || item.name}}">
					{{item.item_name || item.name}}</a>
			</div>
		</div>
		<div class="image-view-body">
			<a  data-item-code="{{ item.name }}"
				title="{{ item.item_name || item.name }}"
			>
				<div class="image-field"
					style="
					{% if (!item.image) { %}
						background-color: #fafbfc;
					{% } %}
					border: 0px;"
				>
					{% if (!item.image) { %}
					<span class="placeholder-text">
						{%= frappe.get_abbr(item.item_name || item.name) %}
					</span>
					{% } %}
					{% if (item.image) { %}
					<img src="{{ item.image }}" alt="{{item.item_name || item.name}}">
					{% } %}
				</div>
			</a>
		</div>
	</div>
	{% if ((i % 4 === 3) || (i===data.length - 1)) { %}</div>{% } %}
{% endfor %}
</div>
`;frappe.templates.employees_to_mark_attendance=`{% if data %}
<div class="col-md-12 col-xs-12" align="center">
	<div class="col-md-12 col-xs-12" style="padding-bottom:15px;">
		<b>Employees to mark attendance</b>
	</div>
	{% for item in data %}
	<div class="col-md-4 col-xs-6" style="padding-bottom:10px;">
		{{ item.employee }} &nbsp;&nbsp; {{ item.employee_name }}
	</div>
	{% } %}
</div>
{% } else { %}
<div></div>
{% } %}
`;erpnext.ItemSelector=class{constructor(e){$.extend(this,e),this.item_field||(this.item_field="item_code"),this.item_query||(this.item_query=erpnext.queries.item().query),this.grid=this.frm.get_field("items").grid,this.setup()}setup(){var e=this;this.grid.add_items_button||(this.grid.add_items_button=this.grid.add_custom_button(__("Add Items"),function(){e.dialog||e.make_dialog(),e.dialog.show(),e.render_items(),setTimeout(function(){e.dialog.input.focus()},1e3)}))}make_dialog(){this.dialog=new frappe.ui.Dialog({title:__("Add Items")});var e=$(this.dialog.body);e.html('<div><p><input type="text" class="form-control"></p>			<br><div class="results"></div></div>'),this.dialog.input=e.find(".form-control"),this.dialog.results=e.find(".results");var t=this;this.dialog.results.on("click",".image-view-item",function(){t.add_item($(this).attr("data-name"))}),this.dialog.input.on("keyup",function(){t.timeout_id&&clearTimeout(t.timeout_id),t.timeout_id=setTimeout(function(){t.render_items(),t.timeout_id=void 0},500)})}add_item(e){var t=!1;if($.each(this.frm.doc.items||[],(r,s)=>{if(s[this.item_field]===e)return frappe.model.set_value(s.doctype,s.name,"qty",s.qty+1),frappe.show_alert({message:__("Added {0} ({1})",[e,s.qty]),indicator:"green"}),t=!0,!1}),!t){var a=null;frappe.run_serially([()=>{a=this.grid.add_new_row()},()=>frappe.model.set_value(a.doctype,a.name,this.item_field,e),()=>frappe.timeout(.1),()=>{frappe.model.set_value(a.doctype,a.name,"qty",1),frappe.show_alert({message:__("Added {0} ({1})",[e,1]),indicator:"green"})}])}}render_items(){let e={query:this.item_query,filters:{}};e.txt=this.dialog.input.val(),e.as_dict=1,this.get_filters&&$.extend(e.filters,this.get_filters()||{});var t=this;frappe.link_search("Item",e,function(a){$.each(a.values,function(r,s){s.image||(s.abbr=frappe.get_abbr(s.item_name),s.color=frappe.get_palette(s.item_name))}),t.dialog.results.html(frappe.render_template("item_selector",{data:a.values}))})}};frappe.provide("frappe.help.help_links");var o="https://erpnext.com/docs/";frappe.help.help_links["Form/Rename Tool"]=[{label:"Bulk Rename",url:o+"user/manual/en/using-erpnext/articles/bulk-rename"}];frappe.help.help_links["List/User"]=[{label:"New User",url:o+"user/manual/en/setting-up/users-and-permissions/adding-users"},{label:"Rename User",url:o+"user/manual/en/setting-up/articles/rename-user"}];frappe.help.help_links["permission-manager"]=[{label:"Role Permissions Manager",url:o+"user/manual/en/setting-up/users-and-permissions/role-based-permissions"},{label:"Managing Perm Level in Permissions Manager",url:o+"user/manual/en/setting-up/articles/managing-perm-level"},{label:"User Permissions",url:o+"user/manual/en/setting-up/users-and-permissions/user-permissions"},{label:"Sharing",url:o+"user/manual/en/setting-up/users-and-permissions/sharing"},{label:"Password",url:o+"user/manual/en/setting-up/articles/change-password"}];frappe.help.help_links["Form/System Settings"]=[{label:"System Settings",url:o+"user/manual/en/setting-up/settings/system-settings"}];frappe.help.help_links["Form/Data Import"]=[{label:"Importing and Exporting Data",url:o+"user/manual/en/setting-up/data/data-import"},{label:"Overwriting Data from Data Import Tool",url:o+"user/manual/en/setting-up/articles/overwriting-data-from-data-import-tool"}];frappe.help.help_links["List/Data Import"]=[{label:"Importing and Exporting Data",url:o+"user/manual/en/setting-up/data/data-import"},{label:"Overwriting Data from Data Import Tool",url:o+"user/manual/en/setting-up/articles/overwriting-data-from-data-import-tool"}];frappe.help.help_links.module_setup=[{label:"Role Permissions Manager",url:o+"user/manual/en/setting-up/users-and-permissions/role-based-permissions"}];frappe.help.help_links["Form/Naming Series"]=[{label:"Naming Series",url:o+"user/manual/en/setting-up/settings/naming-series"},{label:"Setting the Current Value for Naming Series",url:o+"user/manual/en/setting-up/articles/naming-series-current-value"}];frappe.help.help_links["Form/Global Defaults"]=[{label:"Global Settings",url:o+"user/manual/en/setting-up/settings/global-defaults"}];frappe.help.help_links["List/Print Heading"]=[{label:"Print Heading",url:o+"user/manual/en/setting-up/print/print-headings"}];frappe.help.help_links["Form/Print Heading"]=[{label:"Print Heading",url:o+"user/manual/en/setting-up/print/print-headings"}];frappe.help.help_links["List/Letter Head"]=[{label:"Letter Head",url:o+"user/manual/en/setting-up/print/letter-head"}];frappe.help.help_links["List/Address Template"]=[{label:"Address Template",url:o+"user/manual/en/setting-up/print/address-template"}];frappe.help.help_links["List/Terms and Conditions"]=[{label:"Terms and Conditions",url:o+"user/manual/en/setting-up/print/terms-and-conditions"}];frappe.help.help_links["List/Cheque Print Template"]=[{label:"Cheque Print Template",url:o+"user/manual/en/setting-up/print/cheque-print-template"}];frappe.help.help_links["List/Email Account"]=[{label:"Email Account",url:o+"user/manual/en/setting-up/email/email-account"}];frappe.help.help_links["List/Notification"]=[{label:"Notification",url:o+"user/manual/en/setting-up/notifications"}];frappe.help.help_links["Form/Notification"]=[{label:"Notification",url:o+"user/manual/en/setting-up/notifications"}];frappe.help.help_links["Form/Email Digest"]=[{label:"Email Digest",url:o+"user/manual/en/setting-up/email/email-digest"}];frappe.help.help_links["Form/Email Digest"]=[{label:"Email Digest",url:o+"user/manual/en/setting-up/email/email-digest"}];frappe.help.help_links["List/Auto Email Report"]=[{label:"Auto Email Reports",url:o+"user/manual/en/setting-up/email/auto-email-reports"}];frappe.help.help_links["Form/Print Settings"]=[{label:"Print Settings",url:o+"user/manual/en/setting-up/print/print-settings"}];frappe.help.help_links["print-format-builder"]=[{label:"Print Format Builder",url:o+"user/manual/en/setting-up/print/print-format-builder"}];frappe.help.help_links["Form/PayPal Settings"]=[{label:"PayPal Settings",url:o+"user/manual/en/erpnext_integration/paypal-integration"}];frappe.help.help_links["Form/Razorpay Settings"]=[{label:"Razorpay Settings",url:o+"user/manual/en/erpnext_integration/razorpay-integration"}];frappe.help.help_links["Form/Dropbox Settings"]=[{label:"Dropbox Settings",url:o+"user/manual/en/erpnext_integration/dropbox-backup"}];frappe.help.help_links["Form/LDAP Settings"]=[{label:"LDAP Settings",url:o+"user/manual/en/erpnext_integration/ldap-integration"}];frappe.help.help_links["Form/Stripe Settings"]=[{label:"Stripe Settings",url:o+"user/manual/en/erpnext_integration/stripe-integration"}];frappe.help.help_links["Form/Quotation"]=[{label:"Quotation",url:o+"user/manual/en/selling/quotation"},{label:"Applying Discount",url:o+"user/manual/en/selling/articles/applying-discount"},{label:"Sales Person",url:o+"user/manual/en/selling/articles/sales-persons-in-the-sales-transactions"},{label:"Applying Margin",url:o+"user/manual/en/selling/articles/adding-margin"}];frappe.help.help_links["List/Customer"]=[{label:"Customer",url:o+"user/manual/en/CRM/customer"},{label:"Credit Limit",url:o+"user/manual/en/accounts/credit-limit"}];frappe.help.help_links["Form/Customer"]=[{label:"Customer",url:o+"user/manual/en/CRM/customer"},{label:"Credit Limit",url:o+"user/manual/en/accounts/credit-limit"}];frappe.help.help_links["List/Sales Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:o+"user/manual/en/setting-up/setting-up-taxes"}];frappe.help.help_links["Form/Sales Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:o+"user/manual/en/setting-up/setting-up-taxes"}];frappe.help.help_links["List/Sales Order"]=[{label:"Sales Order",url:o+"user/manual/en/selling/sales-order"},{label:"Recurring Sales Order",url:o+"user/manual/en/accounts/articles/recurring-orders-and-invoices"},{label:"Applying Discount",url:o+"user/manual/en/selling/articles/applying-discount"}];frappe.help.help_links["Form/Sales Order"]=[{label:"Sales Order",url:o+"user/manual/en/selling/sales-order"},{label:"Recurring Sales Order",url:o+"user/manual/en/accounts/articles/recurring-orders-and-invoices"},{label:"Applying Discount",url:o+"user/manual/en/selling/articles/applying-discount"},{label:"Drop Shipping",url:o+"user/manual/en/selling/articles/drop-shipping"},{label:"Sales Person",url:o+"user/manual/en/selling/articles/sales-persons-in-the-sales-transactions"},{label:"Close Sales Order",url:o+"user/manual/en/selling/articles/close-sales-order"},{label:"Applying Margin",url:o+"user/manual/en/selling/articles/adding-margin"}];frappe.help.help_links["Form/Product Bundle"]=[{label:"Product Bundle",url:o+"user/manual/en/selling/product-bundle"}];frappe.help.help_links["Form/Selling Settings"]=[{label:"Selling Settings",url:o+"user/manual/en/selling/selling-settings"}];frappe.help.help_links["List/Supplier"]=[{label:"Supplier",url:o+"user/manual/en/buying/supplier"}];frappe.help.help_links["Form/Supplier"]=[{label:"Supplier",url:o+"user/manual/en/buying/supplier"}];frappe.help.help_links["Form/Request for Quotation"]=[{label:"Request for Quotation",url:o+"user/manual/en/buying/request-for-quotation"},{label:"RFQ Video",url:o+"user/videos/learn/request-for-quotation.html"}];frappe.help.help_links["Form/Supplier Quotation"]=[{label:"Supplier Quotation",url:o+"user/manual/en/buying/supplier-quotation"}];frappe.help.help_links["Form/Buying Settings"]=[{label:"Buying Settings",url:o+"user/manual/en/buying/setup/buying-settings"}];frappe.help.help_links["List/Purchase Order"]=[{label:"Purchase Order",url:o+"user/manual/en/buying/purchase-order"},{label:"Recurring Purchase Order",url:o+"user/manual/en/accounts/articles/recurring-orders-and-invoices"}];frappe.help.help_links["Form/Purchase Order"]=[{label:"Purchase Order",url:o+"user/manual/en/buying/purchase-order"},{label:"Item UoM",url:o+"user/manual/en/buying/articles/purchasing-in-different-unit"},{label:"Supplier Item Code",url:o+"user/manual/en/buying/articles/maintaining-suppliers-part-no-in-item"},{label:"Recurring Purchase Order",url:o+"user/manual/en/accounts/articles/recurring-orders-and-invoices"},{label:"Subcontracting",url:o+"user/manual/en/manufacturing/subcontracting"}];frappe.help.help_links["List/Purchase Taxes and Charges Template"]=[{label:"Setting Up Taxes",url:o+"user/manual/en/setting-up/setting-up-taxes"}];frappe.help.help_links["List/Price List"]=[{label:"Price List",url:o+"user/manual/en/stock/price-lists"}];frappe.help.help_links["List/Authorization Rule"]=[{label:"Authorization Rule",url:o+"user/manual/en/customize-erpnext/authorization-rule"}];frappe.help.help_links["Form/SMS Settings"]=[{label:"SMS Settings",url:o+"user/manual/en/setting-up/sms-setting"}];frappe.help.help_links["List/Stock Reconciliation"]=[{label:"Stock Reconciliation",url:o+"user/manual/en/stock/stock-reconciliation"}];frappe.help.help_links["Tree/Territory"]=[{label:"Territory",url:o+"user/manual/en/selling/territory"}];frappe.help.help_links["List/Workflow"]=[{label:"Workflow",url:o+"user/manual/en/setting-up/workflows"}];frappe.help.help_links["List/Company"]=[{label:"Company",url:o+"user/manual/en/setting-up/company-setup"},{label:"Delete All Related Transactions for a Company",url:o+"user/manual/en/setting-up/articles/delete-a-company-and-all-related-transactions"}];frappe.help.help_links["Tree/Account"]=[{label:"Chart of Accounts",url:o+"user/manual/en/accounts/chart-of-accounts"},{label:"Managing Tree Mastes",url:o+"user/manual/en/setting-up/articles/managing-tree-structure-masters"}];frappe.help.help_links["Form/Sales Invoice"]=[{label:"Sales Invoice",url:o+"user/manual/en/accounts/sales-invoice"},{label:"Accounts Opening Balance",url:o+"user/manual/en/accounts/opening-balance"},{label:"Sales Return",url:o+"user/manual/en/stock/sales-return"},{label:"Recurring Sales Invoice",url:o+"user/manual/en/accounts/articles/recurring-orders-and-invoices"}];frappe.help.help_links["List/Sales Invoice"]=[{label:"Sales Invoice",url:o+"user/manual/en/accounts/sales-invoice"},{label:"Accounts Opening Balance",url:o+"user/manual/en/accounts/opening-balances"},{label:"Sales Return",url:o+"user/manual/en/stock/sales-return"},{label:"Recurring Sales Invoice",url:o+"user/manual/en/accounts/articles/recurring-orders-and-invoices"}];frappe.help.help_links["point-of-sale"]=[{label:"Point of Sale Invoice",url:o+"user/manual/en/accounts/point-of-sales"}];frappe.help.help_links["List/POS Profile"]=[{label:"Point of Sale Profile",url:o+"user/manual/en/accounts/pos-profile"}];frappe.help.help_links["Form/POS Profile"]=[{label:"POS Profile",url:o+"user/manual/en/accounts/pos-profile"}];frappe.help.help_links["List/Purchase Invoice"]=[{label:"Purchase Invoice",url:o+"user/manual/en/accounts/purchase-invoice"},{label:"Accounts Opening Balance",url:o+"user/manual/en/accounts/opening-balance"},{label:"Recurring Purchase Invoice",url:o+"user/manual/en/accounts/articles/recurring-orders-and-invoices"}];frappe.help.help_links["List/Journal Entry"]=[{label:"Journal Entry",url:o+"user/manual/en/accounts/journal-entry"},{label:"Advance Payment Entry",url:o+"user/manual/en/accounts/advance-payment-entry"},{label:"Accounts Opening Balance",url:o+"user/manual/en/accounts/opening-balance"}];frappe.help.help_links["List/Payment Entry"]=[{label:"Payment Entry",url:o+"user/manual/en/accounts/payment-entry"}];frappe.help.help_links["List/Payment Request"]=[{label:"Payment Request",url:o+"user/manual/en/accounts/payment-request"}];frappe.help.help_links["List/Asset"]=[{label:"Managing Fixed Assets",url:o+"user/manual/en/asset"}];frappe.help.help_links["List/Asset Category"]=[{label:"Asset Category",url:o+"user/manual/en/asset/asset-category"}];frappe.help.help_links["Tree/Cost Center"]=[{label:"Budgeting",url:o+"user/manual/en/accounts/budgeting"}];frappe.help.help_links["List/Item"]=[{label:"Item",url:o+"user/manual/en/stock/item"},{label:"Item Price",url:o+"user/manual/en/stock/item-price"},{label:"Barcode",url:o+"user/manual/en/stock/articles/track-items-using-barcode"},{label:"Item Wise Taxation",url:o+"user/manual/en/accounts/item-tax-template"},{label:"Managing Fixed Assets",url:o+"user/manual/en/asset"},{label:"Item Codification",url:o+"user/manual/en/stock/articles/item-codification"},{label:"Item Variants",url:o+"user/manual/en/stock/item-variants"},{label:"Item Valuation",url:o+"user/manual/en/stock/articles/item-valuation-fifo-and-moving-average"}];frappe.help.help_links["Form/Item"]=[{label:"Item",url:o+"user/manual/en/stock/item"},{label:"Item Price",url:o+"user/manual/en/stock/item-price"},{label:"Barcode",url:o+"user/manual/en/stock/articles/track-items-using-barcode"},{label:"Item Wise Taxation",url:o+"user/manual/en/accounts/item-tax-template"},{label:"Managing Fixed Assets",url:o+"user/manual/en/asset"},{label:"Item Codification",url:o+"user/manual/en/stock/articles/item-codification"},{label:"Item Variants",url:o+"user/manual/en/stock/item-variants"},{label:"Item Valuation",url:o+"user/manual/en/stock/item/item-valuation-fifo-and-moving-average"}];frappe.help.help_links["List/Purchase Receipt"]=[{label:"Purchase Receipt",url:o+"user/manual/en/stock/purchase-receipt"},{label:"Barcode",url:o+"user/manual/en/stock/articles/track-items-using-barcode"}];frappe.help.help_links["List/Delivery Note"]=[{label:"Delivery Note",url:o+"user/manual/en/stock/delivery-note"},{label:"Barcode",url:o+"user/manual/en/stock/articles/track-items-using-barcode"},{label:"Sales Return",url:o+"user/manual/en/stock/sales-return"}];frappe.help.help_links["Form/Delivery Note"]=[{label:"Delivery Note",url:o+"user/manual/en/stock/delivery-note"},{label:"Sales Return",url:o+"user/manual/en/stock/sales-return"},{label:"Barcode",url:o+"user/manual/en/stock/articles/track-items-using-barcode"}];frappe.help.help_links["List/Installation Note"]=[{label:"Installation Note",url:o+"user/manual/en/stock/installation-note"}];frappe.help.help_links["List/Budget"]=[{label:"Budgeting",url:o+"user/manual/en/accounts/budgeting"}];frappe.help.help_links["List/Material Request"]=[{label:"Material Request",url:o+"user/manual/en/stock/material-request"},{label:"Auto-creation of Material Request",url:o+"user/manual/en/stock/articles/auto-creation-of-material-request"}];frappe.help.help_links["Form/Material Request"]=[{label:"Material Request",url:o+"user/manual/en/stock/material-request"},{label:"Auto-creation of Material Request",url:o+"user/manual/en/stock/articles/auto-creation-of-material-request"}];frappe.help.help_links["Form/Stock Entry"]=[{label:"Stock Entry",url:o+"user/manual/en/stock/stock-entry"},{label:"Stock Entry Types",url:o+"user/manual/en/stock/articles/stock-entry-purpose"},{label:"Repack Entry",url:o+"user/manual/en/stock/articles/repack-entry"},{label:"Opening Stock",url:o+"user/manual/en/stock/opening-stock"},{label:"Subcontracting",url:o+"user/manual/en/manufacturing/subcontracting"}];frappe.help.help_links["List/Stock Entry"]=[{label:"Stock Entry",url:o+"user/manual/en/stock/stock-entry"}];frappe.help.help_links["Tree/Warehouse"]=[{label:"Warehouse",url:o+"user/manual/en/stock/warehouse"}];frappe.help.help_links["List/Serial No"]=[{label:"Serial No",url:o+"user/manual/en/stock/serial-no"}];frappe.help.help_links["Form/Serial No"]=[{label:"Serial No",url:o+"user/manual/en/stock/serial-no"}];frappe.help.help_links["List/Batch"]=[{label:"Batch",url:o+"user/manual/en/stock/batch"}];frappe.help.help_links["Form/Batch"]=[{label:"Batch",url:o+"user/manual/en/stock/batch"}];frappe.help.help_links["Form/Packing Slip"]=[{label:"Packing Slip",url:o+"user/manual/en/stock/packing-slip"}];frappe.help.help_links["Form/Quality Inspection"]=[{label:"Quality Inspection",url:o+"user/manual/en/stock/quality-inspection"}];frappe.help.help_links["Form/Landed Cost Voucher"]=[{label:"Landed Cost Voucher",url:o+"user/manual/en/stock/landed-cost-voucher"}];frappe.help.help_links["Tree/Item Group"]=[{label:"Item Group",url:o+"user/manual/en/stock/item-group"}];frappe.help.help_links["Form/Item Attribute"]=[{label:"Item Attribute",url:o+"user/manual/en/stock/item-attribute"}];frappe.help.help_links["Form/UOM"]=[{label:"Fractions in UOM",url:o+"user/manual/en/stock/articles/managing-fractions-in-uom"}];frappe.help.help_links["Form/Stock Reconciliation"]=[{label:"Opening Stock Entry",url:o+"user/manual/en/stock/stock-reconciliation"}];frappe.help.help_links["Form/Lead"]=[{label:"Lead",url:o+"user/manual/en/CRM/lead"}];frappe.help.help_links["Form/Opportunity"]=[{label:"Opportunity",url:o+"user/manual/en/CRM/opportunity"}];frappe.help.help_links["Form/Address"]=[{label:"Address",url:o+"user/manual/en/CRM/address"}];frappe.help.help_links["Form/Contact"]=[{label:"Contact",url:o+"user/manual/en/CRM/contact"}];frappe.help.help_links["Form/Newsletter"]=[{label:"Newsletter",url:o+"user/manual/en/CRM/newsletter"}];frappe.help.help_links["Form/Campaign"]=[{label:"Campaign",url:o+"user/manual/en/CRM/campaign"}];frappe.help.help_links["Tree/Sales Person"]=[{label:"Sales Person",url:o+"user/manual/en/CRM/sales-person"}];frappe.help.help_links["Form/Sales Person"]=[{label:"Sales Person Target",url:o+"user/manual/en/selling/sales-person-target-allocation"},{label:"Sales Person in Transactions",url:o+"user/manual/en/selling/articles/sales-persons-in-the-sales-transactions"}];frappe.help.help_links["Form/BOM"]=[{label:"Bill of Material",url:o+"user/manual/en/manufacturing/bill-of-materials"},{label:"Nested BOM Structure",url:o+"user/manual/en/manufacturing/articles/managing-multi-level-bom"}];frappe.help.help_links["Form/Work Order"]=[{label:"Work Order",url:o+"user/manual/en/manufacturing/work-order"}];frappe.help.help_links["Form/Workstation"]=[{label:"Workstation",url:o+"user/manual/en/manufacturing/workstation"}];frappe.help.help_links["Form/Operation"]=[{label:"Operation",url:o+"user/manual/en/manufacturing/operation"}];frappe.help.help_links["Form/BOM Update Tool"]=[{label:"BOM Update Tool",url:o+"user/manual/en/manufacturing/bom-update-tool"}];frappe.help.help_links["Form/Customize Form"]=[{label:"Custom Field",url:o+"user/manual/en/customize-erpnext/custom-field"},{label:"Customize Field",url:o+"user/manual/en/customize-erpnext/customize-form"}];frappe.help.help_links["List/Custom Field"]=[{label:"Custom Field",url:o+"user/manual/en/customize-erpnext/custom-field"}];frappe.help.help_links["Form/Custom Field"]=[{label:"Custom Field",url:o+"user/manual/en/customize-erpnext/custom-field"}];frappe.provide("agriculture");agriculture.TernaryPlot=class{constructor(e){Object.assign(this,e),frappe.require("assets/frappe/js/lib/snap.svg-min.js",()=>{this.make_svg(),this.init_snap(),this.init_config(),this.make_plot(),this.make_plot_marking(),this.make_legend(),this.mark_blip()})}make_svg(){this.$svg=$('<svg height="350" width="400">'),$(this.parent).append(this.$svg)}init_snap(){this.paper=new Snap(this.$svg.get(0))}init_config(){this.config={triangle_side:300,spacing:50,strokeWidth:1,stroke:frappe.ui.color.get("black")},this.config.scaling_factor=this.config.triangle_side/100;let{triangle_side:e,spacing:t,scaling_factor:a}=this.config;this.coords={sand:{points:[t+e*Snap.cos(60),t,t,t+e*Snap.cos(30),t+e,t+e*Snap.cos(30)],color:frappe.ui.color.get("peach")},loamy_sand:{points:[t+15*a*Snap.cos(60),t+(100-15)*a*Snap.cos(30),t+10*a*Snap.cos(60),t+(100-10)*a*Snap.cos(30),t+(100-85)*a,t+e*Snap.cos(30),t+(100-70)*a,t+e*Snap.cos(30)],color:frappe.ui.color.get("pink")},sandy_loam:{points:[t+20*a*Snap.cos(60)+27.5*a,t+(100-20)*a*Snap.cos(30),t+20*a*Snap.cos(60),t+(100-20)*a*Snap.cos(30),t+15*a*Snap.cos(60),t+(100-15)*a*Snap.cos(30),t+(100-75)*a,t+e*Snap.cos(30),t+(100-50)*a,t+e*Snap.cos(30),t+(100-50)*a+7.5*a*Snap.cos(60),t+e*Snap.cos(30)-7.5*a*Snap.cos(30),t+(100-50)*a+7.5*a*Snap.cos(60)-10*a,t+e*Snap.cos(30)-7.5*a*Snap.cos(30)],color:frappe.ui.color.get("pink","light")},loam:{points:[t+(100-50)*a+27.5*a*Snap.cos(60),t+e*Snap.cos(30)-27.5*a*Snap.cos(30),t+(100-50)*a+27.5*a*Snap.cos(60)-22.5*a,t+e*Snap.cos(30)-27.5*a*Snap.cos(30),t+20*a*Snap.cos(60)+27.5*a,t+(100-20)*a*Snap.cos(30),t+(100-50)*a+7.5*a*Snap.cos(60)-10*a,t+e*Snap.cos(30)-7.5*a*Snap.cos(30),t+(100-50)*a+7.5*a*Snap.cos(60),t+e*Snap.cos(30)-7.5*a*Snap.cos(30)],color:frappe.ui.color.get("brown")},silt_loam:{points:[t+e-27.5*a*Snap.cos(60),t+72.5*a*Snap.cos(30),t+(100-50)*a+27.5*a*Snap.cos(60),t+e*Snap.cos(30)-27.5*a*Snap.cos(30),t+(100-50)*a,t+e*Snap.cos(30),t+(100-20)*a,t+e*Snap.cos(30),t+(100-20)*a+12.5*a*Snap.cos(60),t+90*a*Snap.cos(30),t+e-12.5*a*Snap.cos(60),t+(100-12.5)*a*Snap.cos(30)],color:frappe.ui.color.get("green","dark")},silt:{points:[t+e-12.5*a*Snap.cos(60),t+(100-12.5)*a*Snap.cos(30),t+(100-20)*a+12.5*a*Snap.cos(60),t+90*a*Snap.cos(30),t+(100-20)*a,t+e*Snap.cos(30),t+e,t+e*Snap.cos(30)],color:frappe.ui.color.get("green")},silty_clay_loam:{points:[t+e-40*a*Snap.cos(60),t+60*a*Snap.cos(30),t+e-40*a*Snap.cos(60)-20*a,t+60*a*Snap.cos(30),t+e-27.5*a*Snap.cos(60)-20*a,t+72.5*a*Snap.cos(30),t+e-27.5*a*Snap.cos(60),t+72.5*a*Snap.cos(30)],color:frappe.ui.color.get("cyan","dark")},silty_clay:{points:[t+e-60*a*Snap.cos(60),t+40*a*Snap.cos(30),t+e-40*a*Snap.cos(60)-20*a,t+60*a*Snap.cos(30),t+e-40*a*Snap.cos(60),t+60*a*Snap.cos(30)],color:frappe.ui.color.get("cyan")},clay_loam:{points:[t+e-40*a*Snap.cos(60)-20*a,t+60*a*Snap.cos(30),t+e-40*a*Snap.cos(60)-45*a,t+60*a*Snap.cos(30),t+e-27.5*a*Snap.cos(60)-45*a,t+72.5*a*Snap.cos(30),t+e-27.5*a*Snap.cos(60)-20*a,t+72.5*a*Snap.cos(30)],color:frappe.ui.color.get("green","light")},sandy_clay_loam:{points:[t+35*a*Snap.cos(60)+20*a,t+(100-35)*a*Snap.cos(30),t+35*a*Snap.cos(60),t+(100-35)*a*Snap.cos(30),t+20*a*Snap.cos(60),t+(100-20)*a*Snap.cos(30),t+20*a*Snap.cos(60)+27.5*a,t+(100-20)*a*Snap.cos(30),t+e-27.5*a*Snap.cos(60)-45*a,t+72.5*a*Snap.cos(30)],color:frappe.ui.color.get("pink","dark")},sandy_clay:{points:[t+55*a*Snap.cos(60),t+(100-55)*a*Snap.cos(30),t+35*a*Snap.cos(60),t+(100-35)*a*Snap.cos(30),t+35*a*Snap.cos(60)+20*a,t+(100-35)*a*Snap.cos(30)],color:frappe.ui.color.get("red")},clay:{points:[t+e*Snap.cos(60),t,t+55*a*Snap.cos(60),t+(100-55)*a*Snap.cos(30),t+e-40*a*Snap.cos(60)-45*a,t+60*a*Snap.cos(30),t+e-40*a*Snap.cos(60)-20*a,t+60*a*Snap.cos(30),t+e-60*a*Snap.cos(60),t+40*a*Snap.cos(30)],color:frappe.ui.color.get("yellow")}}}get_coords(e){return this.coords[e].points}get_color(e){return this.coords[e].color}make_plot(){for(let e in this.coords)this.paper.polygon(this.get_coords(e)).attr({fill:this.get_color(e),stroke:this.config.stroke,strokeWidth:this.config.strokeWidth})}make_plot_marking(){let{triangle_side:e,spacing:t,scaling_factor:a}=this.config;this.paper.text(e*Snap.cos(60)/2,t+e*Snap.cos(30)/2,__("Clay")).attr({fill:frappe.ui.color.get("black")}).transform("r300"),this.paper.text(e,t+e*Snap.cos(30)/2,__("Silt")).attr({fill:frappe.ui.color.get("black")}).transform("r60"),this.paper.text(35+e*Snap.cos(60),90+e*Snap.cos(30),__("Sand")).attr({fill:frappe.ui.color.get("black")}).transform("r0")}make_legend(){let e=1,t=0,a=!0;for(let r in this.coords){e>6&&a&&(t=300,e=1,a=!1);let s=this.paper.rect(0+t,0+e*20,100,19,5,5).attr({fill:this.get_color(r),stroke:frappe.ui.color.get("black")}),n=this.paper.text(5+t,16+e*20,r).attr({fill:frappe.ui.color.get("black"),"font-size":12});e++}}mark_blip({clay:e,sand:t,silt:a}=this){if(e+t+a!=0){let{triangle_side:r,spacing:s,scaling_factor:n}=this.config,l=s+e*n*Snap.cos(60)+a*n,c=s+a*n*Snap.cos(30)+t*n*Snap.sin(60);this.blip=this.paper.circle(l,c,4).attr({fill:frappe.ui.color.get("orange"),stroke:frappe.ui.color.get("orange"),strokeWidth:2})}}remove_blip(){typeof this.blip!="undefined"&&this.blip.remove()}};frappe.templates.item_quick_entry=`<div class="h6 uppercase" style="margin-top: 30px;">{{ __("Variant Attributes") }}</div>
<div class="attributes hide-control">
</div>
`;frappe.provide("frappe.ui.form");frappe.ui.form.ItemQuickEntryForm=class extends frappe.ui.form.QuickEntryForm{constructor(e,t){super(e,t)}render_dialog(){this.mandatory=this.get_variant_fields().concat(this.mandatory),this.mandatory=this.mandatory.concat(this.get_attributes_fields()),this.check_naming_series_based_on(),super.render_dialog(),this.init_post_render_dialog_operations(),this.preset_fields_for_template(),this.dialog.$wrapper.find(".edit-full").text(__("Edit in full page for more options like assets, serial nos, batches etc."))}check_naming_series_based_on(){frappe.defaults.get_default("item_naming_by")==="Naming Series"&&(this.mandatory=this.mandatory.filter(e=>e.fieldname!=="item_code"))}init_post_render_dialog_operations(){this.dialog.fields_dict.attribute_html.$wrapper.append(frappe.render_template("item_quick_entry")),this.init_for_create_variant_trigger(),this.init_for_item_template_trigger(),this.toggle_manufacturer_fields(),this.dialog.get_field("item_template").df.hidden=1,this.dialog.get_field("item_template").refresh()}register_primary_action(){var e=this;this.dialog.set_primary_action(__("Save"),function(){if(!e.dialog.working){var t=e.dialog.get_values(),a={};if(e.dialog.fields_dict.create_variant.$input.prop("checked")&&(a=e.get_variant_doc(),Object.keys(a).length||(t=null),a.stock_uom=e.template_doc.stock_uom,a.item_group=e.template_doc.item_group),t){e.dialog.working=!0;var r=e.update_doc();a.variant_based_on=="Manufacturer"&&(r.variant_based_on="Manufacturer"),$.extend(a,r),e.insert(a)}}})}insert(e){let t=this;return new Promise(a=>{frappe.call({method:"frappe.client.insert",args:{doc:e},callback:function(r){t.dialog.hide(),frappe.model.clear_doc(t.dialog.doc.doctype,t.dialog.doc.name),t.dialog.doc=r.message,frappe._from_link?frappe.ui.form.update_calling_link(t.dialog.doc):t.after_insert?t.after_insert(t.dialog.doc):t.open_form_if_not_list()},error:function(){t.open_doc()},always:function(){t.dialog.working=!1,a(t.dialog.doc)},freeze:!0})})}open_doc(){if(this.dialog.hide(),this.update_doc(),this.dialog.fields_dict.create_variant.$input.prop("checked")){var e=this.dialog.fields_dict.item_template.input.value;e&&frappe.set_route("Form",this.doctype,e)}else frappe.set_route("Form",this.doctype,this.doc.name)}get_variant_fields(){var e=[{fieldname:"create_variant",fieldtype:"Check",label:__("Create Variant")},{fieldname:"item_template",label:__("Item Template"),reqd:0,fieldtype:"Link",options:"Item",get_query:function(){return{filters:{has_variants:1}}}}];return e}get_manufacturing_fields(){return this.manufacturer_fields=[{fieldtype:"Link",options:"Manufacturer",label:"Manufacturer",fieldname:"manufacturer",hidden:1,reqd:0},{fieldtype:"Data",label:"Manufacturer Part Number",fieldname:"manufacturer_part_no",hidden:1,reqd:0}],this.manufacturer_fields}get_attributes_fields(){var e=[{fieldname:"attribute_html",fieldtype:"HTML"}];return e=e.concat(this.get_manufacturing_fields()),e}init_for_create_variant_trigger(){var e=this;this.dialog.fields_dict.create_variant.$input.on("click",function(){e.preset_fields_for_template(),e.init_post_template_trigger_operations(!1,[],!0)})}preset_fields_for_template(){var e=this.dialog.get_value("create_variant");let t=this.dialog.get_field("item_template");t.df.reqd=e,t.set_value(""),t.df.hidden=!e,t.refresh(),["item_code","item_name","item_group","stock_uom"].forEach(a=>{let r=this.dialog.get_field(a);r.df.hidden=e,r.refresh()}),this.dialog.get_field("attribute_html").toggle(!1),["item_code","stock_uom","item_group"].forEach(a=>{let r=this.dialog.get_field(a);r.df.reqd=!e,r.refresh()})}init_for_item_template_trigger(){var e=this;e.dialog.fields_dict.item_template.df.onchange=()=>{var t=e.dialog.fields_dict.item_template.input.value;e.template_doc=null,t?frappe.call({method:"frappe.client.get",args:{doctype:"Item",name:t},callback:function(a){e.template_doc=a.message,e.is_manufacturer=!1,e.template_doc.variant_based_on==="Manufacturer"?e.init_post_template_trigger_operations(!0,[],!0):(e.init_post_template_trigger_operations(!1,e.template_doc.attributes,!1),e.render_attributes(e.template_doc.attributes))}}):(e.dialog.get_field("attribute_html").toggle(!1),e.init_post_template_trigger_operations(!1,[],!0))}}init_post_template_trigger_operations(e,t,a){this.attributes=t,this.attribute_values={},this.attributes_count=t.length,this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes").empty(),this.is_manufacturer=e,this.toggle_manufacturer_fields(),this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes").toggleClass("hide-control",a),this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes-header").toggleClass("hide-control",a)}toggle_manufacturer_fields(){var e=this;$.each(this.manufacturer_fields,function(t,a){e.dialog.get_field(a.fieldname).df.hidden=!e.is_manufacturer,e.dialog.get_field(a.fieldname).df.reqd=a.fieldname=="manufacturer"?e.is_manufacturer:!1,e.dialog.get_field(a.fieldname).refresh()})}initiate_render_attributes(){this.dialog.fields_dict.attribute_html.$wrapper.find(".attributes").empty(),this.render_attributes(this.attributes)}render_attributes(e){var t=this;this.dialog.get_field("attribute_html").toggle(!0),$.each(e,function(a,r){var s="",n="Data";r.numeric_values&&(n="Float",s="Min Value: "+r.from_range+" , Max Value: "+r.to_range+", in Increments of: "+r.increment),t.init_make_control(n,r),t[r.attribute].set_value(t.attribute_values[r.attribute]||""),t[r.attribute].$wrapper.toggleClass("has-error",!t.attribute_values[r.attribute]),$(t[r.attribute].label_area).text(__(r.attribute)),s&&$(repl('<p class="help-box small text-muted hidden-xs">%(desc)s</p>',{desc:s})).insertAfter(t[r.attribute].input_area),r.numeric_values?t[r.attribute].$input.on("change",function(){t.attribute_values[r.attribute]=$(this).val(),$(this).closest(".frappe-control").toggleClass("has-error",!$(this).val())}):t.init_awesomplete_for_attribute(r)})}init_make_control(e,t){this[t.attribute]=frappe.ui.form.make_control({df:{fieldtype:e,label:t.attribute,fieldname:t.attribute,options:t.options||""},parent:$(this.dialog.fields_dict.attribute_html.wrapper).find(".attributes"),only_input:!1}),this[t.attribute].make_input()}init_awesomplete_for_attribute(e){var t=this;this[e.attribute].input.awesomplete=new Awesomplete(this[e.attribute].input,{minChars:0,maxItems:99,autoFirst:!0,list:[]}),this[e.attribute].$input.on("input",function(a){frappe.call({method:"frappe.client.get_list",args:{doctype:"Item Attribute Value",filters:[["parent","=",$(a.target).attr("data-fieldname")],["attribute_value","like",a.target.value+"%"]],fields:["attribute_value"],parent:"Item Attribute"},callback:function(r){r.message&&(a.target.awesomplete.list=r.message.map(function(s){return s.attribute_value}))}})}).on("focus",function(a){$(a.target).val("").trigger("input")}).on("awesomplete-close",function(a){t.attribute_values[$(a.target).attr("data-fieldname")]=a.target.value,$(a.target).closest(".frappe-control").toggleClass("has-error",!a.target.value)})}get_variant_doc(){var e=this,t={},a=this.validate_mandatory_attributes();return Object.keys(a).length&&frappe.call({method:"erpnext.controllers.item_variant.create_variant_doc_for_quick_entry",args:{template:e.dialog.fields_dict.item_template.$input.val(),args:a},async:!1,callback:function(r){if(Object.prototype.toString.call(r.message)=="[object Object]")t=r.message;else{var s=frappe.msgprint(__("Item Variant {0} already exists with same attributes",[repl('<a class="strong variant-click" data-item-code="%(item)s" 								>%(item)s</a>',{item:r.message})]));s.$wrapper.find(".variant-click").on("click",function(){s.hide(),e.dialog.hide(),frappe._from_link?frappe._from_link.set_value($(this).attr("data-item-code")):frappe.set_route("Form","Item",$(this).attr("data-item-code"))})}}}),t}validate_mandatory_attributes(){var e=this,t={},a=[];return $.each(this.attributes,function(r,s){var n=e.attribute_values[s.attribute]||"";n?t[s.attribute]=s.numeric_values?flt(n):n:a.push(s.attribute)}),this.is_manufacturer&&$.each(this.manufacturer_fields,function(r,s){t[s.fieldname]=e.dialog.fields_dict[s.fieldname].input.value}),t}};frappe.provide("frappe.ui.form");frappe.ui.form.CustomerQuickEntryForm=class extends frappe.ui.form.QuickEntryForm{constructor(e,t,a,r,s){super(e,t,a,r,s);this.skip_redirect_on_error=!0}render_dialog(){this.mandatory=this.mandatory.concat(this.get_variant_fields()),super.render_dialog()}get_variant_fields(){var e=[{fieldtype:"Section Break",label:__("Primary Contact Details"),collapsible:1},{label:__("Email Id"),fieldname:"email_id",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("Mobile Number"),fieldname:"mobile_no",fieldtype:"Data"},{fieldtype:"Section Break",label:__("Primary Address Details"),collapsible:1},{label:__("Address Line 1"),fieldname:"address_line1",fieldtype:"Data"},{label:__("Address Line 2"),fieldname:"address_line2",fieldtype:"Data"},{label:__("ZIP Code"),fieldname:"pincode",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("City"),fieldname:"city",fieldtype:"Data"},{label:__("State"),fieldname:"state",fieldtype:"Data"},{label:__("Country"),fieldname:"country",fieldtype:"Link",options:"Country"},{label:__("Customer POS Id"),fieldname:"customer_pos_id",fieldtype:"Data",hidden:1}];return e}};frappe.provide("frappe.ui.form");frappe.ui.form.SupplierQuickEntryForm=class extends frappe.ui.form.QuickEntryForm{constructor(e,t,a,r,s){super(e,t,a,r,s);this.skip_redirect_on_error=!0}render_dialog(){this.mandatory=this.mandatory.concat(this.get_variant_fields()),super.render_dialog()}get_variant_fields(){var e=[{fieldtype:"Section Break",label:__("Primary Contact Details"),collapsible:1},{label:__("Email Id"),fieldname:"email_id",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("Mobile Number"),fieldname:"mobile_no",fieldtype:"Data"},{fieldtype:"Section Break",label:__("Primary Address Details"),collapsible:1},{label:__("Address Line 1"),fieldname:"address_line1",fieldtype:"Data"},{label:__("Address Line 2"),fieldname:"address_line2",fieldtype:"Data"},{label:__("ZIP Code"),fieldname:"pincode",fieldtype:"Data"},{fieldtype:"Column Break"},{label:__("City"),fieldname:"city",fieldtype:"Data"},{label:__("State"),fieldname:"state",fieldtype:"Data"},{label:__("Country"),fieldname:"country",fieldtype:"Link",options:"Country"}];return e}};frappe.templates.student_button=`<div class="col-sm-3">
    <div class="checkbox">
        <label>
            <input
                type="checkbox"
                data-group_roll_number="{{group_roll_number}}"
                data-student="{{student}}"
                data-student-name="{{student_name}}"
                class="students-check"
                {% if status === "Present" %}
                checked
                {% endif %}
                >
            {{ group_roll_number }} - {{ student_name }}
        </label>
    </div>
</div>
`;frappe.templates.assessment_result_tool=`<table class="table table-bordered assessment-result-tool">
	<thead>
		<tr>
			<th style="width: 90px" rowspan="2">Student</th>
			<th style="width: 170px" rowspan="2">Student Name</th>
			{% for c in criteria %}
			<th class="score" style="width: 100px">{{ c.assessment_criteria }}</th>
			{% endfor %}
			<th class="score" style="width: 170px" rowspan="2">Comments</th>
			<th class="score" style="width: 100px">Total Marks</th>
			<!--criteria-->
		</tr>
		<tr>
			{% for c in criteria %}
			<th class="score" style="width: 100px">Score ({{ c.maximum_score }})</th>
			{% endfor %}
			<th class="score" style="width: 100px">Score ({{max_total_score}})</th>
		</tr>
	</thead>
	<tbody>
		{% for s in students %}
		<tr
			{% if(s.assessment_details && s.docstatus && s.docstatus == 1) { %} class="text-muted" {% } %}
			data-student="{{s.student}}">

			<td>{{ s.student }}</td>
			<td>{{ s.student_name }}</td>
			{% for c in criteria %}
			<td>
				<span data-student="{{s.student}}" data-criteria="{{c.assessment_criteria}}" class="student-result-grade badge" >
					{% if(s.assessment_details) { %}
						{{s.assessment_details[c.assessment_criteria][1]}}
					{% } %}
				</span>
				<input type="number" class="student-result-data" style="width:70%; float:right;"
					data-max-score="{{c.maximum_score}}"
					data-criteria="{{c.assessment_criteria}}"
					data-student="{{s.student}}"
					{% if(s.assessment_details && s.docstatus && s.docstatus == 1) { %} disabled {% } %}
					{% if(s.assessment_details) { %}
						value="{{s.assessment_details[c.assessment_criteria][0]}}"
					{% } %}/>
			</td>
			{% endfor %}
			<td>
				<input type="text" class="result-comment" data-student="{{s.student}}"
				{% if(s.assessment_details && s.docstatus && s.docstatus == 1) { %} disabled {% } %}
				{% if(s.assessment_details) { %}
					value="{{s.assessment_details.comment}}"
				{% } %}
			</td>
			<td>
				<span data-student="{{s.student}}" class="total-score-grade badge" style="width:30%; float:left;">
				{% if(s.assessment_details) { %}
				{{s.assessment_details.total_score[1]}}
				{% } %}
				</span>
				<span data-student="{{s.student}}" class="total-score" style="width:60%; float:center;">
				{% if(s.assessment_details) { %}
				{{s.assessment_details.total_score[0]}}
				{% } %}
				</span>
				<span data-student="{{s.student}}" class="total-result-link" style="width: 10%; display:{% if(!s.assessment_details) { %}None{% } %}; float:right;">
					<a class="btn-open no-decoration" title="Open Link" href="/app/Form/Assessment Result/{% if(s.assessment_details) { %}{{s.name}}{% } %}">
						<i class="octicon octicon-arrow-right"></i>
					</a>
				</span>
			</td>
		</tr>
		{% endfor %}
	</tbody>
</table>
`;var u=class{constructor(e){this.caller_number=e.from,this.call_log=e,this.setup_listener(),this.make()}make(){frappe.utils.play_sound("incoming-call"),this.dialog=new frappe.ui.Dialog({static:!0,minimizable:!0}),this.dialog.get_close_btn().show(),this.setup_dialog(),this.set_call_status(),frappe.utils.bind_actions_with_object(this.dialog.$body,this),this.dialog.$wrapper.addClass("call-popup"),this.dialog.get_close_btn().unbind("click").click(this.close_modal.bind(this)),this.dialog.show()}setup_dialog(){this.setup_call_details(),this.dialog.$body.empty().append(this.caller_info)}set_indicator(e,t=!1){let a=`indicator ${e} ${t?"blink":""}`;this.dialog.header.find(".indicator").attr("class",a)}set_call_status(e){let t="";e=e||this.call_log.status,["Ringing"].includes(e)||!e?(t=__("Incoming call from {0}",[this.get_caller_name()||this.caller_number]),this.set_indicator("blue",!0)):e==="In Progress"?(t=__("Call Connected"),this.set_indicator("green")):["No Answer","Missed"].includes(e)?(this.set_indicator("yellow"),t=__("Call Missed")):["Completed","Busy","Failed"].includes(e)?(this.set_indicator("red"),t=__("Call Ended")):(this.set_indicator("blue"),t=e),this.dialog.set_title(t)}update_call_log(e,t){this.call_log=e,this.set_call_status(t?"Missed":null)}close_modal(){this.dialog.hide(),delete erpnext.call_popup}call_ended(e,t){frappe.utils.play_sound("call-disconnect"),this.update_call_log(e,t),setTimeout(()=>{this.dialog.get_value("call_summary")||this.close_modal()},6e4),this.clear_listeners()}get_caller_name(){let e=this.get_contact_link();return e.link_title||e.link_name}get_contact_link(){return this.call_log.links.find(a=>a.link_doctype==="Contact")||{}}setup_listener(){frappe.realtime.on(`call_${this.call_log.id}_ended`,e=>{this.call_ended(e)}),frappe.realtime.on(`call_${this.call_log.id}_missed`,e=>{this.call_ended(e,!0)})}clear_listeners(){frappe.realtime.off(`call_${this.call_log.id}_ended`),frappe.realtime.off(`call_${this.call_log.id}_missed`)}setup_call_details(){this.caller_info=$("<div></div>"),this.call_details=new frappe.ui.FieldGroup({fields:[{fieldname:"name",label:"Name",default:this.get_caller_name()||__("Unknown Caller"),fieldtype:"Data",read_only:1},{fieldtype:"Button",label:__("Open Contact"),click:()=>frappe.set_route("Form","Contact",this.get_contact_link().link_name),depends_on:()=>this.get_caller_name()},{fieldtype:"Button",label:__("Create New Contact"),click:this.create_new_contact.bind(this),depends_on:()=>!this.get_caller_name()},{fieldtype:"Button",label:__("Create New Customer"),click:this.create_new_customer.bind(this),depends_on:()=>!this.get_caller_name()},{fieldtype:"Button",label:__("Create New Lead"),click:()=>frappe.new_doc("Lead",{mobile_no:this.caller_number}),depends_on:()=>!this.get_caller_name()},{fieldtype:"Column Break"},{fieldname:"number",label:"Phone Number",fieldtype:"Data",default:this.caller_number,read_only:1},{fieldtype:"Section Break",hide_border:1},{fieldtype:"Small Text",label:__("Call Summary"),fieldname:"call_summary"},{fieldtype:"Button",label:__("Save"),click:()=>{let e=this.call_details.get_value("call_summary");!e||frappe.xcall("erpnext.telephony.doctype.call_log.call_log.add_call_summary",{call_log:this.call_log.name,summary:e}).then(()=>{this.close_modal(),frappe.show_alert({message:`
								${__("Call Summary Saved")}
								<br>
								<a
									class="text-small text-muted"
									href="/app/call-log/${this.call_log.name}">
									${__("View call log")}
								</a>
							`,indicator:"green"})})}}],body:this.caller_info}),this.call_details.make()}is_known_caller(){return Boolean(this.get_caller_name())}create_new_customer(){let e=frappe.model.get_new_doc("Customer");e.mobile_no=this.caller_number,frappe.set_route("Form",e.doctype,e.name)}create_new_contact(){let e=frappe.model.get_new_doc("Contact"),t=frappe.model.add_child(e,"Contact Phone","phone_nos");t.phone=this.caller_number,t.is_primary_mobile_no=1,frappe.set_route("Form",e.doctype,e.name)}};$(document).on("app_ready",function(){frappe.realtime.on("show_call_popup",i=>{let e=erpnext.call_popup;e&&i.name===e.call_log.name?(e.update_call_log(i),e.dialog.show()):erpnext.call_popup=new u(i)})});window.CallPopup=u;frappe.provide("erpnext.accounts");erpnext.accounts.dimensions={setup_dimension_filters(i,e){this.accounting_dimensions=[],this.default_dimensions={},this.fetch_custom_dimensions(i,e)},fetch_custom_dimensions(i,e){let t=this;frappe.call({method:"erpnext.accounts.doctype.accounting_dimension.accounting_dimension.get_dimensions",args:{with_cost_center_and_project:!0},callback:function(a){t.accounting_dimensions=a.message[0],t.default_dimensions=a.message[1],t.setup_filters(i,e)}})},setup_filters(i,e){this.accounting_dimensions&&this.accounting_dimensions.forEach(t=>{frappe.model.with_doctype(t.document_type,()=>{let a=[];frappe.meta.get_docfields(e).forEach(r=>{r.fieldtype==="Link"&&r.options==="Account"?a.push(r.fieldname):r.fieldtype==="Table"&&this.setup_child_filters(i,r.options,r.fieldname,t.fieldname),frappe.meta.has_field(e,t.fieldname)&&this.setup_account_filters(i,t.fieldname,a)})})})},setup_child_filters(i,e,t,a){let r=[];frappe.meta.has_field(e,a)&&frappe.model.with_doctype(e,()=>{frappe.meta.get_docfields(e).forEach(s=>{s.fieldtype==="Link"&&s.options==="Account"&&r.push(s.fieldname)}),i.set_query(a,t,function(s,n,l){let c=locals[n][l];return erpnext.queries.get_filtered_dimensions(c,r,a,s.company)})})},setup_account_filters(i,e,t){i.set_query(e,function(a){return erpnext.queries.get_filtered_dimensions(a,t,e,a.company)})},update_dimension(i,e){this.accounting_dimensions&&this.accounting_dimensions.forEach(t=>{if(i.is_new()&&i.doc.company&&Object.keys(this.default_dimensions||{}).length>0&&this.default_dimensions[i.doc.company]){let a=this.default_dimensions[i.doc.company][t.fieldname];a&&(frappe.meta.has_field(e,t.fieldname)&&i.set_value(t.fieldname,a),$.each(i.doc.items||i.doc.accounts||[],function(r,s){frappe.model.set_value(s.doctype,s.name,t.fieldname,a)}))}})},copy_dimension_from_first_row(i,e,t,a){frappe.meta.has_field(i.doctype,a)&&this.accounting_dimensions&&this.accounting_dimensions.forEach(r=>{let s=frappe.get_doc(e,t);i.script_manager.copy_from_first_row(a,s,[r.fieldname])})}};frappe.ui.form.ControlData=class extends frappe.ui.form.ControlData{make_input(){super.make_input(),this.df.options=="Phone"&&this.setup_phone(),this.frm&&this.frm.fields_dict&&Object.values(this.frm.fields_dict).forEach(function(e){e.df.read_only===1&&e.df.options==="Phone"&&e.disp_area.style[0]!="display"&&!e.has_icon&&(e.setup_phone(),e.has_icon=!0)})}setup_phone(){if(frappe.phone_call.handler){let e=this.df.read_only?".control-value":".control-input";this.$wrapper.find(e).append(`
					<span class="phone-btn">
						<a class="btn-open no-decoration" title="${__("Make a call")}">
							${frappe.utils.icon("call")}
					</span>
				`).find(".phone-btn").click(()=>{frappe.phone_call.handler(this.get_value(),this.frm)})}}};frappe.templates.call_link=`<div class="call-detail-wrapper">
	<div class="head flex justify-between">
		<div>
			<span class="bold"> {{ type }} Call</span>
			{% if (duration) %}
			<span class="text-muted"> \u2022 {{ frappe.format(duration, { fieldtype: "Duration" }) }}</span>
			{% endif %}
			<span class="text-muted"> \u2022 {{ comment_when(creation) }}</span>
		</div>
		<span>
			<a class="action-btn" href="/app/call-log/{{ name }}" title="{{ __("Open Call Log") }}">
				<svg class="icon icon-sm">
					<use href="#icon-link-url" class="like-icon"></use>
				</svg>
			</a>
		</span>
	</div>


	<div class="body pt-3">
		{% if (type === "Incoming") { %}
			<span> Incoming call from {{ from }}, received by {{ to }}</span>
		{% } else { %}
			<span> Outgoing Call made by {{ from }} to {{ to }}</span>
		{% } %}
		<div class="summary pt-3">
		{% if (summary) { %}
			<i>{{ summary }}</i>
		{% } else { %}
			<i class="text-muted">{{ __("No Summary") }}</i>
		{% } %}
		</div>
		{% if (recording_url) { %}
		<div class="margin-top">
				<audio
					controls
					src="{{ recording_url }}">
				</audio>
		</div>
		{% } %}
	</div>
</div>
`;frappe.provide("erpnext.bulk_transaction_processing");$.extend(erpnext.bulk_transaction_processing,{create:function(i,e,t){let a=i.get_checked_items(),r=[];a.forEach(n=>{n.docstatus==0&&r.push(n.name)});let s=a.length;frappe.confirm(__("Create {0} {1} ?",[s,t]),()=>{r.length==0?(frappe.call({method:"erpnext.utilities.bulk_transaction.transaction_processing",args:{data:a,from_doctype:e,to_doctype:t}}).then(()=>{}),s>10&&frappe.show_alert("Starting a background job to create {0} {1}",[s,t])):frappe.msgprint(__("Selected document must be in submitted state"))})}});})();
//# sourceMappingURL=erpnext.bundle.65AQCPMV.js.map
